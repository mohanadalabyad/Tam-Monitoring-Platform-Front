<div class="my-private-violations-page">
  <!-- List view (header, table, cards) - hidden when form-only mode (form page) -->
  <ng-container *ngIf="!formOnlyMode">
  <div class="page-header">
    <div>
      <h1>بلاغاتي الخاصة</h1>
      <p>إدارة وعرض البلاغات الخاصة التي قمت بإنشائها</p>
    </div>
    <div class="header-actions">
      <app-view-toggle
        [storageKey]="'my-private-violations-view-mode'"
        [defaultView]="'table'"
        (viewChange)="onViewChange($event)"
      ></app-view-toggle>
      <button 
        class="btn-primary" 
        (click)="openAddModal()" 
        *hasPermission="'PrivateViolation.Create'"
      >
        <lucide-icon [img]="Plus" [size]="18"></lucide-icon>
        إضافة بلاغ خاص جديد
      </button>
    </div>
  </div>

  <!-- Table View -->
  <div *ngIf="viewMode === 'table'">
    <app-unified-table
      [columns]="columns"
      [data]="searchTerm ? filteredViolations : violations"
      [loading]="loading"
      [actions]="actions"
      [pageSize]="pageSize"
      [serverSidePagination]="!searchTerm"
      [currentPageNumber]="currentPage"
      [totalPagesCount]="totalPages"
      [totalCount]="searchTerm ? filteredViolations.length : totalCount"
      emptyMessage="لا توجد بلاغات خاصة"
      (rowClick)="viewDetails($event)"
      (pageChange)="onPageChange($event)"
      (searchChange)="onSearchChange($event)"
    ></app-unified-table>
  </div>

  <!-- Cards View -->
  <div *ngIf="viewMode === 'cards'" class="violations-cards-view">
    <!-- Search Box for Cards View -->
    <div class="cards-search-box">
      <div class="search-box">
        <input
          type="text"
          [value]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="بحث في البلاغات..."
          class="search-input"
        />
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </div>
    </div>
    
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>جاري تحميل البلاغات...</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : violations).length === 0" class="empty-state">
      <p>{{ searchTerm ? 'لا توجد نتائج للبحث' : 'لا توجد بلاغات خاصة' }}</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : violations).length > 0" class="violations-grid">
      <div *ngFor="let violation of (searchTerm ? filteredViolations : violations)" class="violation-card">
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">بلاغ #{{ violation.id }}</h3>
            <div class="card-badges">
              <span class="card-badge" [class.badge-pending]="violation.acceptanceStatus === AcceptanceStatus.Pending" 
                [class.badge-approved]="violation.acceptanceStatus === AcceptanceStatus.Approved" 
                [class.badge-rejected]="violation.acceptanceStatus === AcceptanceStatus.Rejected">
                {{ getAcceptanceStatusLabel(violation.acceptanceStatus) }}
              </span>
              <span class="card-badge" [class.badge-published]="violation.publishStatus === PublishStatus.Publish" 
                [class.badge-unpublished]="violation.publishStatus === PublishStatus.NotPublish">
                {{ getPublishStatusLabel(violation.publishStatus) }}
              </span>
            </div>
          </div>
          <div class="card-actions-header">
            <button
              type="button"
              class="card-action-icon btn-view"
              (click)="viewDetails(violation); $event.stopPropagation()"
              title="عرض التفاصيل"
            >
              <lucide-icon [img]="Eye" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="violation.acceptanceStatus === AcceptanceStatus.Pending"
              type="button"
              class="card-action-icon btn-edit"
              (click)="editViolation(violation); $event.stopPropagation()"
              title="تعديل"
            >
              <lucide-icon [img]="Pencil" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="violation.acceptanceStatus === AcceptanceStatus.Pending"
              type="button"
              class="card-action-icon btn-delete"
              (click)="deleteViolation(violation); $event.stopPropagation()"
              title="حذف"
            >
              <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
            </button>
          </div>
        </div>
        <div class="card-content">
          <div class="card-field">
            <span class="field-label">المدينة:</span>
            <span class="field-value">{{ violation.cityName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة:</span>
            <span class="field-value">{{ violation.categoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة الفرعية:</span>
            <span class="field-value">{{ violation.subCategoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">تاريخ الحادثة:</span>
            <span class="field-value">{{ violation.violationDate | date:'mediumDate' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الموقع:</span>
            <span class="field-value">{{ violation.location || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الوصف:</span>
            <span class="field-value">{{ violation.description || 'لا يوجد وصف' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  </ng-container>

  <!-- Form only (used on form page) -->
  <ng-container *ngIf="formOnlyMode">
  <form [formGroup]="violationForm">
      <!-- Draft Restoration Banner -->
      <div class="draft-banner" *ngIf="hasDraft && !editingViolation">
        <div class="draft-banner-content">
          <div class="draft-info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            <div class="draft-text">
              <strong>لديك مسودة محفوظة</strong>
              <span class="draft-timestamp" *ngIf="draftTimestamp">
                من {{ draftTimestamp | date:'mediumDate' }}
              </span>
            </div>
          </div>
          <div class="draft-actions">
            <button type="button" class="btn-draft-restore" (click)="loadDraft()">
              استعادة المسودة
            </button>
            <button type="button" class="btn-draft-clear" (click)="startFresh()">
              بدء جديد
            </button>
          </div>
        </div>
      </div>

      <!-- Steps Indicator (5 steps for افادات, 6 for استبيان) -->
      <div class="steps-indicator">
        <div 
          *ngFor="let step of stepNumbers" 
          class="step-item"
          [class.active]="currentStep === step"
          [class.completed]="currentStep > step"
          (click)="goToStep(step)"
        >
          <div class="step-number">{{ step }}</div>
          <div class="step-label">{{ getStepLabel(step) }}</div>
        </div>
      </div>

      <!-- Step 1: Basic Information -->
      <div *ngIf="currentStep === 1" class="form-step">
        <h2 class="step-title">المعلومات الأساسية</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-6">
            <label for="kind">نوع البلاغ *</label>
            <select id="kind" formControlName="kind" [class.invalid]="isFieldInvalid('kind')">
              <option [ngValue]="PrivateViolationKind.Questionnaire">استبيان</option>
              <option [ngValue]="PrivateViolationKind.Testimony">افادات</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('kind')">
              نوع البلاغ مطلوب
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="cityId">المدينة *</label>
            <select id="cityId" formControlName="cityId" [class.invalid]="isFieldInvalid('cityId')">
              <option [value]="''">اختر المدينة</option>
              <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('cityId')">
              المدينة مطلوبة
            </div>
          </div>

          <div class="form-group col-6">
            <label for="categoryId">الفئة *</label>
            <select id="categoryId" formControlName="categoryId" [class.invalid]="isFieldInvalid('categoryId')">
              <option [value]="''">اختر الفئة</option>
              <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('categoryId')">
              الفئة مطلوبة
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="subCategoryId">الفئة الفرعية *</label>
            <select 
              id="subCategoryId" 
              formControlName="subCategoryId" 
              [class.invalid]="isFieldInvalid('subCategoryId')"
            >
              <option [value]="''">اختر الفئة الفرعية</option>
              <option *ngFor="let subCategory of subCategories" [value]="subCategory.id">{{ subCategory.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('subCategoryId')">
              الفئة الفرعية مطلوبة
            </div>
          </div>

          <div class="form-group col-6">
            <label for="violationDate">تاريخ الحادثة *</label>
            <input
              type="date"
              id="violationDate"
              formControlName="violationDate"
              [class.invalid]="isFieldInvalid('violationDate')"
            />
            <div class="error-message" *ngIf="isFieldInvalid('violationDate')">
              تاريخ الحادثة مطلوب
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="location">الموقع *</label>
            <input
              type="text"
              id="location"
              formControlName="location"
              [class.invalid]="isFieldInvalid('location')"
              placeholder="أدخل موقع الحادثة"
            />
            <div class="error-message" *ngIf="isFieldInvalid('location')">
              الموقع مطلوب
            </div>
          </div>

          <div class="form-group col-6">
            <label for="role">الصفة *</label>
            <select id="role" formControlName="role" [class.invalid]="isFieldInvalid('role')">
              <option [ngValue]="PrivateViolationRole.Witness">شاهد</option>
              <option [ngValue]="PrivateViolationRole.DirectVictim">ضحية مباشرة</option>
              <option [ngValue]="PrivateViolationRole.InstitutionRepresentative">ممثل مؤسسة</option>
              <option [ngValue]="PrivateViolationRole.Other">أخرى</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('role')">
              الصفة مطلوبة
            </div>
          </div>
        </div>

        <div class="form-row" *ngIf="violationForm.get('role')?.value === PrivateViolationRole.Other">
          <div class="form-group">
            <label for="otherRoleText">تحديد الصفة *</label>
            <input
              type="text"
              id="otherRoleText"
              formControlName="otherRoleText"
              [class.invalid]="isFieldInvalid('otherRoleText')"
              placeholder="أدخل الصفة"
            />
            <div class="error-message" *ngIf="isFieldInvalid('otherRoleText')">
              تحديد الصفة مطلوب
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="description">الوصف</label>
            <textarea
              id="description"
              formControlName="description"
              placeholder="أدخل وصف الحادثة (اختياري)"
              rows="4"
            ></textarea>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 2: Personal/Victim Information -->
      <div *ngIf="currentStep === 2" class="form-step">
        <h2 class="step-title">معلومات الضحية/الشخص</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalName">الاسم</label>
            <input
              type="text"
              id="personalName"
              formControlName="personalName"
              placeholder="اسم الضحية/الشخص"
            />
          </div>

          <div class="form-group col-6">
            <label for="personalCityId">مدينة الإقامة</label>
            <select id="personalCityId" formControlName="personalCityId">
              <option [ngValue]="null">اختر مدينة الإقامة</option>
              <option *ngFor="let city of cities" [ngValue]="city.id">
                {{ city.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalAddress">العنوان</label>
            <input
              type="text"
              id="personalAddress"
              formControlName="personalAddress"
              placeholder="عنوان الإقامة"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalAge">العمر</label>
            <input
              type="number"
              id="personalAge"
              formControlName="personalAge"
              placeholder="العمر"
              min="0"
            />
          </div>

          <div class="form-group col-6">
            <label for="personalDateOfBirth">تاريخ الميلاد</label>
            <input
              type="date"
              id="personalDateOfBirth"
              formControlName="personalDateOfBirth"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalEducationId">المستوى التعليمي</label>
            <select id="personalEducationId" formControlName="personalEducationId">
              <option [ngValue]="null">اختر المستوى التعليمي</option>
              <option *ngFor="let level of educationLevels" [ngValue]="level.id">
                {{ level.name }}
              </option>
            </select>
          </div>

          <div class="form-group col-6">
            <label for="gender">الجنس</label>
            <select id="gender" formControlName="gender">
              <option [ngValue]="null">اختر الجنس</option>
              <option [ngValue]="Gender.Male">ذكر</option>
              <option [ngValue]="Gender.Female">أنثى</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="maritalStatus">الحالة الاجتماعية</label>
            <select
              id="maritalStatus"
              formControlName="maritalStatus"
            >
              <option [ngValue]="null">اختر الحالة الاجتماعية</option>
              <option [ngValue]="MaritalStatus.Married">متزوج/ه</option>
              <option [ngValue]="MaritalStatus.Divorced">مطلق/ه</option>
              <option [ngValue]="MaritalStatus.Widowed">أرمل/ه</option>
              <option [ngValue]="MaritalStatus.Single">عازب/عزباء</option>
            </select>
          </div>

          <div class="form-group col-6">
            <label for="work">العمل</label>
            <input
              type="text"
              id="work"
              formControlName="work"
              placeholder="العمل"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label class="checkbox-wrapper">
              <input
                type="checkbox"
                formControlName="hasDisability"
              />
              <span>لديه إعاقة</span>
            </label>
          </div>
        </div>

        <div class="form-row" *ngIf="violationForm.get('hasDisability')?.value">
          <div class="form-group">
            <label for="disabilityType">نوع الإعاقة</label>
            <input
              type="text"
              id="disabilityType"
              formControlName="disabilityType"
              placeholder="نوع الإعاقة"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-wrapper">
              <input
                type="checkbox"
                formControlName="showPersonalInfoInPublish"
              />
              <span>عرض المعلومات الشخصية عند النشر</span>
            </label>
            <p class="form-hint">عند تفعيل هذا الخيار، سيتم عرض المعلومات الشخصية للضحية عند نشر البلاغ</p>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 3: Contact Information -->
      <div *ngIf="currentStep === 3" class="form-step">
        <h2 class="step-title">معلومات الاتصال</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-12">
            <label class="checkbox-wrapper">
              <input
                type="checkbox"
                formControlName="canBeContacted"
              />
              <span>يمكن الاتصال به</span>
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="contactName">اسم جهة الاتصال</label>
            <input
              type="text"
              id="contactName"
              formControlName="contactName"
              placeholder="اسم جهة الاتصال"
            />
          </div>

          <div class="form-group col-6">
            <label for="contactAddress">عنوان جهة الاتصال</label>
            <input
              type="text"
              id="contactAddress"
              formControlName="contactAddress"
              placeholder="عنوان جهة الاتصال"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="contactEmail">البريد الإلكتروني</label>
            <input
              type="email"
              id="contactEmail"
              formControlName="contactEmail"
              [class.invalid]="isFieldInvalid('contactEmail')"
              placeholder="example@domain.com"
            />
            <div class="error-message" *ngIf="isFieldInvalid('contactEmail')">
              بريد إلكتروني صحيح مطلوب
            </div>
          </div>

          <div class="form-group col-6">
            <label for="contactPhone">رقم الهاتف</label>
            <input
              type="tel"
              id="contactPhone"
              formControlName="contactPhone"
              placeholder="رقم الهاتف"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="preferredContactMethod">طريقة الاتصال المفضلة</label>
            <select id="preferredContactMethod" formControlName="preferredContactMethod">
              <option [ngValue]="null">اختر طريقة الاتصال المفضلة</option>
              <option [ngValue]="PreferredContactMethod.Phone">هاتف</option>
              <option [ngValue]="PreferredContactMethod.Email">بريد إلكتروني</option>
            </select>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 4: محتوى الإفادة (افادات only - HTML rich text editor) -->
      <div *ngIf="currentStep === 4 && isTestimonyKind" class="form-step form-step-testimony" #testimonyStepRef>
        <h2 class="step-title">محتوى الإفادة</h2>
        <p class="step-description">أدخل نص الإفادة. يمكنك استخدام التنسيق (عريض، قوائم، عناوين، إلخ).</p>
        <div class="form-section form-section-testimony-editor">
          <div class="form-group col-12 testimony-editor-wrapper">
            <label for="testimonyContent">محتوى الإفادة *</label>
            <div class="testimony-editor-container">
              <textarea
                formControlName="testimonyContent"
                class="form-control testimony-textarea"
                dir="rtl"
                placeholder="أدخل محتوى الإفادة..."
                rows="10"
                [class.is-invalid]="isFieldInvalid('testimonyContent')"
              ></textarea>
            </div>
            <div class="error-message" *ngIf="isFieldInvalid('testimonyContent')">
              محتوى الإفادة مطلوب
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Questions (استبيان) -->
      <div *ngIf="currentStep === 4 && !isTestimonyKind" class="form-step">
        <h2 class="step-title">الأسئلة</h2>
        <div class="form-section" *ngIf="loadingQuestions">
          <div class="loading-questions">
            <div class="spinner"></div>
            <p>جاري تحميل الأسئلة...</p>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length > 0">
          <div class="questions-container" [formGroup]="questionsForm">
            <app-dynamic-question
              *ngFor="let question of sortedQuestions; trackBy: trackByQuestionId"
              [question]="question"
              [formControlName]="'question_' + question.id"
            ></app-dynamic-question>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length === 0 && violationForm.get('categoryId')?.value">
          <div class="empty-questions-message">
            <p>لا توجد أسئلة لهذه الفئة</p>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length === 0 && !violationForm.get('categoryId')?.value">
          <div class="empty-questions-message">
            <p>يرجى اختيار الفئة أولاً</p>
          </div>
        </div>
      </div>

      <!-- Step 5: مرفقات الإفادة (افادات only - required) -->
      <div *ngIf="currentStep === 5 && isTestimonyKind" class="form-step">
        <h2 class="step-title">مرفقات الإفادة <span class="required-badge">* مطلوب</span></h2>
        <p class="step-description">مرفق واحد على الأقل مطلوب لنوع إفادة. يرجى إضافة مرفق (صورة، فيديو، أو مستند) قبل المتابعة.</p>
        <div class="error-message step-error" *ngIf="testimonyAttachmentPreviews.length === 0">
          مرفق واحد على الأقل مطلوب لنوع افادات. يرجى إضافة مرفق للمتابعة.
        </div>
        <div class="form-section">
        <div class="file-upload-area">
          <input
            type="file"
            id="fileInputTestimony"
            multiple
            accept="image/*,video/*,.pdf,.doc,.docx"
            (change)="onTestimonyFileSelected($event)"
            style="display: none;"
            #fileInputTestimony
          />
          <button type="button" class="btn-secondary" (click)="fileInputTestimony.click()">
            <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
            إضافة مرفقات الإفادة
          </button>
        </div>

        <div class="attachments-preview" *ngIf="testimonyAttachmentPreviews.length > 0">
          <div *ngFor="let preview of testimonyAttachmentPreviews; let i = index" class="attachment-preview-item">
            <img
              *ngIf="isImage(preview.file?.type || '')"
              [src]="preview.preview"
              [alt]="preview.file?.name || 'attachment'"
              class="attachment-image"
            />
            <video
              *ngIf="isVideo(preview.file?.type || '')"
              [src]="preview.preview"
              controls
              class="attachment-video"
              (click)="$event.stopPropagation()"
            ></video>
            <div *ngIf="!isImage(preview.file?.type || '') && !isVideo(preview.file?.type || '')" class="attachment-file-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>{{ preview.file?.name || 'ملف' }}</span>
            </div>
            <button
              type="button"
              class="remove-attachment"
              (click)="removeTestimonyAttachment(i)"
              title="إزالة"
            >
              ×
            </button>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 6: مرفقات (افادات only - optional) -->
      <div *ngIf="currentStep === 6 && isTestimonyKind" class="form-step">
        <h2 class="step-title">مرفقات (اختياري)</h2>
        <p class="step-description">يمكنك إضافة مرفقات إضافية أو تخطي هذه الخطوة.</p>
        <div class="form-section">
        <div class="file-upload-area">
          <input
            type="file"
            id="fileInputNormalTestimony"
            multiple
            accept="image/*,video/*,.pdf,.doc,.docx"
            (change)="onFileSelected($event)"
            style="display: none;"
            #fileInputNormalTestimony
          />
          <button type="button" class="btn-secondary" (click)="fileInputNormalTestimony.click()">
            <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
            إضافة مرفقات
          </button>
        </div>

        <div class="attachments-preview" *ngIf="attachmentPreviews.length > 0">
          <div *ngFor="let preview of attachmentPreviews; let i = index" class="attachment-preview-item">
            <img
              *ngIf="isImage(preview.file?.type || '')"
              [src]="preview.preview"
              [alt]="preview.file?.name || 'attachment'"
              class="attachment-image"
            />
            <video
              *ngIf="isVideo(preview.file?.type || '')"
              [src]="preview.preview"
              controls
              class="attachment-video"
              (click)="$event.stopPropagation()"
            ></video>
            <div *ngIf="!isImage(preview.file?.type || '') && !isVideo(preview.file?.type || '')" class="attachment-file-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>{{ preview.file?.name || 'ملف' }}</span>
            </div>
            <button
              type="button"
              class="remove-attachment"
              (click)="removeAttachment(i)"
              title="إزالة"
            >
              ×
            </button>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 5: Attachments (استبيان only) -->
      <div *ngIf="currentStep === 5 && !isTestimonyKind" class="form-step">
        <h2 class="step-title">المرفقات (اختياري)</h2>
        <div class="form-section">
        <div class="file-upload-area">
          <input
            type="file"
            id="fileInput"
            multiple
            accept="image/*,video/*,.pdf,.doc,.docx"
            (change)="onFileSelected($event)"
            style="display: none;"
            #fileInput
          />
          <button type="button" class="btn-secondary" (click)="fileInput.click()">
            <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
            إضافة مرفقات
          </button>
        </div>

        <div class="attachments-preview" *ngIf="attachmentPreviews.length > 0">
          <div *ngFor="let preview of attachmentPreviews; let i = index" class="attachment-preview-item">
            <img
              *ngIf="isImage(preview.file?.type || '')"
              [src]="preview.preview"
              [alt]="preview.file?.name || 'attachment'"
              class="attachment-image"
            />
            <video
              *ngIf="isVideo(preview.file?.type || '')"
              [src]="preview.preview"
              controls
              class="attachment-video"
              (click)="$event.stopPropagation()"
            ></video>
            <div *ngIf="!isImage(preview.file?.type || '') && !isVideo(preview.file?.type || '')" class="attachment-file-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>{{ preview.file?.name || 'ملف' }}</span>
            </div>
            <button
              type="button"
              class="remove-attachment"
              (click)="removeAttachment(i)"
              title="إزالة"
            >
              ×
            </button>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 7: Review (افادات); Step 6: Review (استبيان) -->
      <div *ngIf="(currentStep === 7 && isTestimonyKind) || (currentStep === 6 && !isTestimonyKind)" class="form-step">
        <h2 class="step-title">المراجعة والإرسال</h2>
        <p class="step-description">يرجى مراجعة المعلومات قبل الإرسال</p>
        
        <!-- Current Form Data Review -->
        <div class="review-section">
          <h3 class="review-card-title">البيانات الحالية</h3>
          <div class="review-grid">
            <div class="review-item">
              <div class="review-label">
                <strong>نوع البلاغ:</strong>
              </div>
              <div class="review-value">{{ getKindValue() }}</div>
            </div>
            <div class="review-item" *ngIf="isTestimonyKind && getTestimonyContentValue()">
              <div class="review-label">
                <strong>محتوى الإفادة:</strong>
              </div>
              <div class="review-value testimony-content-preview" [innerHTML]="getTestimonyContentValue()"></div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>المدينة:</strong>
              </div>
              <div class="review-value">{{ getSelectedCityName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة:</strong>
              </div>
              <div class="review-value">{{ getSelectedCategoryName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة الفرعية:</strong>
              </div>
              <div class="review-value">{{ getSelectedSubCategoryName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>تاريخ الحادثة:</strong>
              </div>
              <div class="review-value">{{ getViolationDateValue() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الموقع:</strong>
              </div>
              <div class="review-value">{{ getLocationValue() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الصفة:</strong>
              </div>
              <div class="review-value">{{ getRoleValue() }}</div>
            </div>
            <div class="review-item" *ngIf="getOtherRoleTextValue()">
              <div class="review-label">
                <strong>تحديد الصفة:</strong>
              </div>
              <div class="review-value">{{ getOtherRoleTextValue() }}</div>
            </div>
            <div class="review-item review-item-full">
              <div class="review-label">
                <strong>الوصف:</strong>
              </div>
              <div class="review-value review-description">{{ getDescriptionValue() }}</div>
            </div>
            <!-- Personal/Victim Information -->
            <div class="review-item" *ngIf="violationForm.get('personalName')?.value">
              <div class="review-label">
                <strong>اسم الضحية:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalName')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalCityId')?.value">
              <div class="review-label">
                <strong>مدينة الإقامة:</strong>
              </div>
              <div class="review-value">{{ getPersonalCityValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalAddress')?.value">
              <div class="review-label">
                <strong>العنوان:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalAddress')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalAge')?.value">
              <div class="review-label">
                <strong>العمر:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalAge')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalDateOfBirth')?.value">
              <div class="review-label">
                <strong>تاريخ الميلاد:</strong>
              </div>
              <div class="review-value">{{ getPersonalDateOfBirthValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalEducationId')?.value">
              <div class="review-label">
                <strong>المستوى التعليمي:</strong>
              </div>
              <div class="review-value">{{ getPersonalEducationValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('gender')?.value">
              <div class="review-label">
                <strong>الجنس:</strong>
              </div>
              <div class="review-value">{{ getGenderValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('maritalStatus')?.value">
              <div class="review-label">
                <strong>الحالة الاجتماعية:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('maritalStatus')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('work')?.value">
              <div class="review-label">
                <strong>العمل:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('work')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('hasDisability')?.value">
              <div class="review-label">
                <strong>لديه إعاقة:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('hasDisability')?.value ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('disabilityType')?.value">
              <div class="review-label">
                <strong>نوع الإعاقة:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('disabilityType')?.value }}</div>
            </div>
            <!-- Contact Information -->
            <div class="review-item" *ngIf="violationForm.get('canBeContacted')?.value">
              <div class="review-label">
                <strong>يمكن الاتصال به:</strong>
              </div>
              <div class="review-value">نعم</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('contactName')?.value">
              <div class="review-label">
                <strong>اسم جهة الاتصال:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactName')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('contactAddress')?.value">
              <div class="review-label">
                <strong>عنوان جهة الاتصال:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactAddress')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('contactEmail')?.value">
              <div class="review-label">
                <strong>البريد الإلكتروني:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactEmail')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('contactPhone')?.value">
              <div class="review-label">
                <strong>رقم الهاتف:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactPhone')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('preferredContactMethod')?.value">
              <div class="review-label">
                <strong>طريقة الاتصال المفضلة:</strong>
              </div>
              <div class="review-value">{{ getPreferredContactMethodLabel(violationForm.get('preferredContactMethod')?.value) }}</div>
            </div>
            <!-- Question Answers (استبيان only; إفادة has testimony content, no questions) -->
            <div class="review-item review-item-full" *ngIf="!isTestimonyKind && sortedQuestions.length > 0">
              <div class="review-label">
                <strong>الإجابات على الأسئلة:</strong>
              </div>
              <div class="review-value">
                <div class="question-answers-list">
                  <div *ngFor="let question of sortedQuestions" class="question-answer-item">
                    <div class="question-text">{{ question.text }}</div>
                    <div class="answer-value" *ngIf="hasQuestionAnswer(question.id)">
                      {{ getQuestionAnswerValue(question.id) }}
                    </div>
                    <div class="answer-value no-answer" *ngIf="!hasQuestionAnswer(question.id)">
                      لا توجد إجابة
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>عرض المعلومات الشخصية عند النشر:</strong>
              </div>
              <div class="review-value">{{ (violationForm.get('showPersonalInfoInPublish')?.value) ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="isTestimonyKind && (testimonyAttachmentPreviews.length > 0 || attachmentPreviews.length > 0)">
              <div class="review-label">
                <strong>مرفقات الإفادة:</strong>
              </div>
              <div class="review-value">{{ testimonyAttachmentPreviews.length }}</div>
            </div>
            <div class="review-item" *ngIf="isTestimonyKind && attachmentPreviews.length > 0">
              <div class="review-label">
                <strong>مرفقات:</strong>
              </div>
              <div class="review-value">{{ attachmentPreviews.length }}</div>
            </div>
            <div class="review-item" *ngIf="!isTestimonyKind && attachmentPreviews.length > 0">
              <div class="review-label">
                <strong>عدد المرفقات:</strong>
              </div>
              <div class="review-value">{{ attachmentPreviews.length }}</div>
            </div>
          </div>
        </div>
        
        <!-- Original Data (only when editing and data has changed) -->
        <div *ngIf="editingViolation && originalViolationData && hasDataChanged()" class="review-section original-data">
          <h3 class="review-card-title">البيانات الأصلية (قبل التعديل)</h3>
          <div class="review-grid">
            <div class="review-item">
              <div class="review-label">
                <strong>المدينة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.cityName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.categoryName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة الفرعية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.subCategoryName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>تاريخ الحادثة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.violationDate | date:'mediumDate' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الموقع:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.location || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الصفة:</strong>
              </div>
              <div class="review-value">{{ getPrivateViolationRoleLabel(originalViolationData.role) }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.otherRoleText">
              <div class="review-label">
                <strong>تحديد الصفة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.otherRoleText }}</div>
            </div>
            <div class="review-item review-item-full">
              <div class="review-label">
                <strong>الوصف:</strong>
              </div>
              <div class="review-value review-description">{{ originalViolationData.description || 'لا يوجد وصف' }}</div>
            </div>
            <!-- Personal/Victim Information -->
            <div class="review-item" *ngIf="originalViolationData.personalName">
              <div class="review-label">
                <strong>اسم الضحية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalName }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalCityId || originalViolationData.personalCity">
              <div class="review-label">
                <strong>مدينة الإقامة:</strong>
              </div>
              <div class="review-value">
                <span *ngIf="originalViolationData.personalCityId">
                  {{ getCityNameById(originalViolationData.personalCityId) }}
                </span>
                <span *ngIf="!originalViolationData.personalCityId && originalViolationData.personalCity">
                  {{ originalViolationData.personalCity }}
                </span>
              </div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalAddress">
              <div class="review-label">
                <strong>العنوان:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalAddress }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalAge">
              <div class="review-label">
                <strong>العمر:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalAge }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalDateOfBirth">
              <div class="review-label">
                <strong>تاريخ الميلاد:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalDateOfBirth | date:'mediumDate' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalEducationId">
              <div class="review-label">
                <strong>المستوى التعليمي:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalEducationName || 'غير محدد' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.gender">
              <div class="review-label">
                <strong>الجنس:</strong>
              </div>
              <div class="review-value">{{ getGenderLabel(originalViolationData.gender) }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.maritalStatus">
              <div class="review-label">
                <strong>الحالة الاجتماعية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.maritalStatus ? getMaritalStatusLabel(originalViolationData.maritalStatus) : '' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.work">
              <div class="review-label">
                <strong>العمل:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.work }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.hasDisability">
              <div class="review-label">
                <strong>لديه إعاقة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.hasDisability ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.disabilityType">
              <div class="review-label">
                <strong>نوع الإعاقة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.disabilityType }}</div>
            </div>
            <!-- Contact Information -->
            <div class="review-item" *ngIf="originalViolationData.canBeContacted">
              <div class="review-label">
                <strong>يمكن الاتصال به:</strong>
              </div>
              <div class="review-value">نعم</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.contactName">
              <div class="review-label">
                <strong>اسم جهة الاتصال:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactName }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.contactAddress">
              <div class="review-label">
                <strong>عنوان جهة الاتصال:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactAddress }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.contactEmail">
              <div class="review-label">
                <strong>البريد الإلكتروني:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactEmail }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.contactPhone">
              <div class="review-label">
                <strong>رقم الهاتف:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactPhone }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.preferredContactMethod">
              <div class="review-label">
                <strong>طريقة الاتصال المفضلة:</strong>
              </div>
              <div class="review-value">{{ getPreferredContactMethodLabel(originalViolationData.preferredContactMethod) }}</div>
            </div>
            <!-- Question Answers (استبيان only) -->
            <div class="review-item review-item-full" *ngIf="originalViolationData.kind !== PrivateViolationKind.Testimony && originalViolationData.questionAnswers && originalViolationData.questionAnswers.length > 0">
              <div class="review-label">
                <strong>الإجابات على الأسئلة:</strong>
              </div>
              <div class="review-value">
                <div class="question-answers-list">
                  <div *ngFor="let answer of originalViolationData.questionAnswers" class="question-answer-item">
                    <div class="question-text">{{ answer.questionText || 'سؤال #' + answer.questionId }}</div>
                    <div class="answer-value">{{ answer.answerValue || 'لا توجد إجابة' }}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>عرض المعلومات الشخصية عند النشر:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.showPersonalInfoInPublish ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.attachments && originalViolationData.attachments.length > 0">
              <div class="review-label">
                <strong>عدد المرفقات:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.attachments.length }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button
          type="button"
          class="btn-secondary"
          (click)="previousStep()"
          [disabled]="currentStep === 1"
        >
          السابق
        </button>
        <button
          *ngIf="currentStep < totalSteps"
          type="button"
          class="btn-primary"
          (click)="nextStep()"
        >
          التالي
        </button>
        <button
          *ngIf="currentStep === totalSteps"
          type="button"
          class="btn-primary"
          (click)="saveViolation()"
          [disabled]="loading"
        >
          {{ editingViolation ? 'حفظ التغييرات' : 'إضافة' }}
        </button>
        <button
          type="button"
          class="btn-draft"
          (click)="saveDraft()"
          *ngIf="!editingViolation"
        >
          حفظ كمسودة
        </button>
        <button
          type="button"
          class="btn-secondary"
          (click)="closeModal()"
        >
          إلغاء
        </button>
      </div>
    </form>
  </ng-container>

  <!-- Follow-Up Modal (list page only) -->
  <ng-container *ngIf="!formOnlyMode">
  <app-modal
    [show]="showFollowUpModal"
    title="إضافة Follow-up"
    size="lg"
    (close)="closeFollowUpModal()"
  >
    <div *ngIf="selectedViolationForFollowUp">
      <!-- Follow-Up History -->
      <div class="follow-up-history" *ngIf="followUps.length > 0">
        <h3 class="section-title">سجل المتابعة</h3>
        <div class="history-list" *ngIf="!loadingFollowUps">
          <div *ngFor="let followUp of followUps" class="history-item">
            <div class="history-header">
              <span class="history-status">{{ followUp.followUpStatusName }}</span>
              <span class="history-date">{{ followUp.creationDate | date:'mediumDate' }}</span>
            </div>
            <div class="history-note">{{ followUp.note }}</div>
            <div class="history-attachments" *ngIf="followUp.attachments && followUp.attachments.length > 0">
              <span class="history-attachments-label">المرفقات:</span>
              <div class="history-attachments-grid">
                <div *ngFor="let att of followUp.attachments" class="history-attachment-item">
                  <a (click)="openAttachment(att.filePath)" href="javascript:void(0)" target="_blank" rel="noopener noreferrer">
                    <img *ngIf="isImage(att.fileType)" class="history-attachment-image" [src]="getAttachmentUrl(att.filePath)" [alt]="att.fileName" />
                    <div *ngIf="!isImage(att.fileType)" class="history-attachment-file">
                      <span>{{ att.fileName }}</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
            <div class="history-user">بواسطة: {{ followUp.createdByUserName || 'غير معروف' }}</div>
          </div>
        </div>
        <div *ngIf="loadingFollowUps" class="loading-state">
          <div class="spinner"></div>
          <p>جاري تحميل سجل المتابعة...</p>
        </div>
      </div>

      <!-- Add New Follow-Up Form -->
      <div class="follow-up-form">
        <h3 class="section-title">إضافة Follow-up جديد</h3>
        <form [formGroup]="followUpForm">
          <div class="form-group">
            <label for="followUpStatusId">حالة المتابعة *</label>
            <select
              id="followUpStatusId"
              formControlName="followUpStatusId"
              class="form-control"
              [class.invalid]="followUpForm.get('followUpStatusId')?.invalid && followUpForm.get('followUpStatusId')?.touched"
            >
              <option [ngValue]="null">اختر حالة المتابعة</option>
              <option *ngFor="let status of followUpStatuses" [ngValue]="status.id">
                {{ status.name }}
              </option>
            </select>
            <div class="error-message" *ngIf="followUpForm.get('followUpStatusId')?.invalid && followUpForm.get('followUpStatusId')?.touched">
              حالة المتابعة مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label for="note">الملاحظة *</label>
            <textarea
              id="note"
              formControlName="note"
              placeholder="أدخل الملاحظة"
              rows="4"
              class="form-control"
              [class.invalid]="followUpForm.get('note')?.invalid && followUpForm.get('note')?.touched"
            ></textarea>
            <div class="error-message" *ngIf="followUpForm.get('note')?.invalid && followUpForm.get('note')?.touched">
              الملاحظة مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label>مرفقات (اختياري، حد أقصى 100 ميجابايت للملف)</label>
            <input
              type="file"
              #followUpFileInput
              multiple
              accept="image/*,video/*,.pdf,.doc,.docx"
              (change)="onFollowUpFileSelected($event)"
              style="display: none;"
            />
            <button type="button" class="btn-secondary" (click)="followUpFileInput.click()">
              <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
              إضافة مرفقات
            </button>
            <div class="follow-up-attachments-list" *ngIf="followUpAttachments.length > 0">
              <span *ngFor="let f of followUpAttachments; let i = index" class="follow-up-attachment-tag">
                {{ f.name }}
                <button type="button" class="remove-follow-up-attachment" (click)="removeFollowUpAttachment(i)" title="إزالة">×</button>
              </span>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <div footer>
      <button type="button" class="btn-secondary" (click)="closeFollowUpModal()">
        إغلاق
      </button>
      <button type="button" class="btn-primary" (click)="saveFollowUp()" [disabled]="loading || followUpForm.invalid">
        <span *ngIf="loading">جاري الحفظ...</span>
        <span *ngIf="!loading">حفظ</span>
      </button>
    </div>
  </app-modal>
  </ng-container>
</div>
