<div class="my-private-violations-page">
  <div class="page-header">
    <div>
      <h1>بلاغاتي الخاصة</h1>
      <p>إدارة وعرض البلاغات الخاصة التي قمت بإنشائها</p>
    </div>
    <div class="header-actions">
      <app-view-toggle
        [storageKey]="'my-private-violations-view-mode'"
        [defaultView]="'table'"
        (viewChange)="onViewChange($event)"
      ></app-view-toggle>
      <button 
        class="btn-primary" 
        (click)="openAddModal()" 
        *hasPermission="'PrivateViolation.Create'"
      >
        <lucide-icon [img]="Plus" [size]="18"></lucide-icon>
        إضافة بلاغ خاص جديد
      </button>
    </div>
  </div>

  <!-- Table View -->
  <div *ngIf="viewMode === 'table'">
    <app-unified-table
      [columns]="columns"
      [data]="searchTerm ? filteredViolations : violations"
      [loading]="loading"
      [actions]="actions"
      [pageSize]="pageSize"
      [serverSidePagination]="!searchTerm"
      [currentPageNumber]="currentPage"
      [totalPagesCount]="totalPages"
      [totalCount]="searchTerm ? filteredViolations.length : totalCount"
      emptyMessage="لا توجد بلاغات خاصة"
      (rowClick)="viewDetails($event)"
      (pageChange)="onPageChange($event)"
      (searchChange)="onSearchChange($event)"
    ></app-unified-table>
  </div>

  <!-- Cards View -->
  <div *ngIf="viewMode === 'cards'" class="violations-cards-view">
    <!-- Search Box for Cards View -->
    <div class="cards-search-box">
      <div class="search-box">
        <input
          type="text"
          [value]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="بحث في البلاغات..."
          class="search-input"
        />
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </div>
    </div>
    
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>جاري تحميل البلاغات...</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : violations).length === 0" class="empty-state">
      <p>{{ searchTerm ? 'لا توجد نتائج للبحث' : 'لا توجد بلاغات خاصة' }}</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : violations).length > 0" class="violations-grid">
      <div *ngFor="let violation of (searchTerm ? filteredViolations : violations)" class="violation-card">
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">بلاغ #{{ violation.id }}</h3>
            <div class="card-badges">
              <span class="card-badge" [class.badge-pending]="violation.acceptanceStatus === AcceptanceStatus.Pending" 
                [class.badge-approved]="violation.acceptanceStatus === AcceptanceStatus.Approved" 
                [class.badge-rejected]="violation.acceptanceStatus === AcceptanceStatus.Rejected">
                {{ getAcceptanceStatusLabel(violation.acceptanceStatus) }}
              </span>
              <span class="card-badge" [class.badge-published]="violation.publishStatus === PublishStatus.Publish" 
                [class.badge-unpublished]="violation.publishStatus === PublishStatus.NotPublish">
                {{ getPublishStatusLabel(violation.publishStatus) }}
              </span>
            </div>
          </div>
          <div class="card-actions-header">
            <button
              type="button"
              class="card-action-icon btn-view"
              (click)="viewDetails(violation); $event.stopPropagation()"
              title="عرض التفاصيل"
            >
              <lucide-icon [img]="Eye" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="violation.acceptanceStatus === AcceptanceStatus.Pending"
              type="button"
              class="card-action-icon btn-edit"
              (click)="editViolation(violation); $event.stopPropagation()"
              title="تعديل"
            >
              <lucide-icon [img]="Pencil" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="violation.acceptanceStatus === AcceptanceStatus.Pending"
              type="button"
              class="card-action-icon btn-delete"
              (click)="deleteViolation(violation); $event.stopPropagation()"
              title="حذف"
            >
              <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
            </button>
          </div>
        </div>
        <div class="card-content">
          <div class="card-field">
            <span class="field-label">المدينة:</span>
            <span class="field-value">{{ violation.cityName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة:</span>
            <span class="field-value">{{ violation.categoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة الفرعية:</span>
            <span class="field-value">{{ violation.subCategoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">تاريخ الحادثة:</span>
            <span class="field-value">{{ violation.violationDate | date:'medium' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الموقع:</span>
            <span class="field-value">{{ violation.location || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الوصف:</span>
            <span class="field-value">{{ violation.description || 'لا يوجد وصف' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <app-modal
    [show]="showModal"
    [title]="modalTitle"
    size="lg"
    (close)="closeModal()"
  >
    <form [formGroup]="violationForm" *ngIf="showModal">
      <!-- Steps Indicator -->
      <div class="steps-indicator">
        <div 
          *ngFor="let step of [1,2,3,4,5,6]; let i = index" 
          class="step-item"
          [class.active]="currentStep === step"
          [class.completed]="currentStep > step"
          (click)="goToStep(step)"
        >
          <div class="step-number">{{ step }}</div>
          <div class="step-label">
            <span *ngIf="step === 1">المعلومات الأساسية</span>
            <span *ngIf="step === 2">معلومات الضحية</span>
            <span *ngIf="step === 3">معلومات الاتصال</span>
            <span *ngIf="step === 4">الأسئلة</span>
            <span *ngIf="step === 5">المرفقات</span>
            <span *ngIf="step === 6">المراجعة</span>
          </div>
        </div>
      </div>

      <!-- Step 1: Basic Information -->
      <div *ngIf="currentStep === 1" class="form-step">
        <h2 class="step-title">المعلومات الأساسية</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-6">
            <label for="cityId">المدينة *</label>
            <select id="cityId" formControlName="cityId" [class.invalid]="isFieldInvalid('cityId')">
              <option [value]="''">اختر المدينة</option>
              <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('cityId')">
              المدينة مطلوبة
            </div>
          </div>

          <div class="form-group col-6">
            <label for="categoryId">الفئة *</label>
            <select id="categoryId" formControlName="categoryId" [class.invalid]="isFieldInvalid('categoryId')">
              <option [value]="''">اختر الفئة</option>
              <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('categoryId')">
              الفئة مطلوبة
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="subCategoryId">الفئة الفرعية *</label>
            <select 
              id="subCategoryId" 
              formControlName="subCategoryId" 
              [class.invalid]="isFieldInvalid('subCategoryId')"
            >
              <option [value]="''">اختر الفئة الفرعية</option>
              <option *ngFor="let subCategory of subCategories" [value]="subCategory.id">{{ subCategory.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('subCategoryId')">
              الفئة الفرعية مطلوبة
            </div>
          </div>

          <div class="form-group col-6">
            <label for="violationDate">تاريخ الحادثة *</label>
            <input
              type="date"
              id="violationDate"
              formControlName="violationDate"
              [class.invalid]="isFieldInvalid('violationDate')"
            />
            <div class="error-message" *ngIf="isFieldInvalid('violationDate')">
              تاريخ الحادثة مطلوب
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="location">الموقع *</label>
            <input
              type="text"
              id="location"
              formControlName="location"
              [class.invalid]="isFieldInvalid('location')"
              placeholder="أدخل موقع الحادثة"
            />
            <div class="error-message" *ngIf="isFieldInvalid('location')">
              الموقع مطلوب
            </div>
          </div>

          <div class="form-group col-6">
            <label for="role">الصفة *</label>
            <select id="role" formControlName="role" [class.invalid]="isFieldInvalid('role')">
              <option [ngValue]="PrivateViolationRole.Witness">شاهد</option>
              <option [ngValue]="PrivateViolationRole.DirectVictim">ضحية مباشرة</option>
              <option [ngValue]="PrivateViolationRole.InstitutionRepresentative">ممثل مؤسسة</option>
              <option [ngValue]="PrivateViolationRole.Other">أخرى</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid('role')">
              الصفة مطلوبة
            </div>
          </div>
        </div>

        <div class="form-row" *ngIf="violationForm.get('role')?.value === PrivateViolationRole.Other">
          <div class="form-group">
            <label for="otherRoleText">تحديد الصفة *</label>
            <input
              type="text"
              id="otherRoleText"
              formControlName="otherRoleText"
              [class.invalid]="isFieldInvalid('otherRoleText')"
              placeholder="أدخل الصفة"
            />
            <div class="error-message" *ngIf="isFieldInvalid('otherRoleText')">
              تحديد الصفة مطلوب
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="description">الوصف *</label>
            <textarea
              id="description"
              formControlName="description"
              [class.invalid]="isFieldInvalid('description')"
              placeholder="أدخل وصف الحادثة"
              rows="4"
            ></textarea>
            <div class="error-message" *ngIf="isFieldInvalid('description')">
              الوصف مطلوب
            </div>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 2: Personal/Victim Information -->
      <div *ngIf="currentStep === 2" class="form-step">
        <h2 class="step-title">معلومات الضحية/الشخص</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalName">الاسم</label>
            <input
              type="text"
              id="personalName"
              formControlName="personalName"
              placeholder="اسم الضحية/الشخص"
            />
          </div>

          <div class="form-group col-6">
            <label for="personalCity">مدينة الإقامة</label>
            <input
              type="text"
              id="personalCity"
              formControlName="personalCity"
              placeholder="مدينة الإقامة"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalAddress">العنوان</label>
            <input
              type="text"
              id="personalAddress"
              formControlName="personalAddress"
              placeholder="عنوان الإقامة"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalAge">العمر</label>
            <input
              type="number"
              id="personalAge"
              formControlName="personalAge"
              placeholder="العمر"
              min="0"
            />
          </div>

          <div class="form-group col-6">
            <label for="personalDateOfBirth">تاريخ الميلاد</label>
            <input
              type="date"
              id="personalDateOfBirth"
              formControlName="personalDateOfBirth"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="personalEducation">المستوى التعليمي</label>
            <input
              type="text"
              id="personalEducation"
              formControlName="personalEducation"
              placeholder="المستوى التعليمي"
            />
          </div>

          <div class="form-group col-6">
            <label for="gender">الجنس</label>
            <select id="gender" formControlName="gender">
              <option [ngValue]="null">اختر الجنس</option>
              <option [ngValue]="Gender.Male">ذكر</option>
              <option [ngValue]="Gender.Female">أنثى</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label for="maritalStatus">الحالة الاجتماعية</label>
            <input
              type="text"
              id="maritalStatus"
              formControlName="maritalStatus"
              placeholder="الحالة الاجتماعية"
            />
          </div>

          <div class="form-group col-6">
            <label for="work">العمل</label>
            <input
              type="text"
              id="work"
              formControlName="work"
              placeholder="العمل"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-6">
            <label class="checkbox-wrapper">
              <input
                type="checkbox"
                formControlName="hasDisability"
              />
              <span>لديه إعاقة</span>
            </label>
          </div>
        </div>

        <div class="form-row" *ngIf="violationForm.get('hasDisability')?.value">
          <div class="form-group">
            <label for="disabilityType">نوع الإعاقة</label>
            <input
              type="text"
              id="disabilityType"
              formControlName="disabilityType"
              placeholder="نوع الإعاقة"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-wrapper">
              <input
                type="checkbox"
                formControlName="showPersonalInfoInPublish"
              />
              <span>عرض المعلومات الشخصية عند النشر</span>
            </label>
            <p class="form-hint">عند تفعيل هذا الخيار، سيتم عرض المعلومات الشخصية للضحية عند نشر البلاغ</p>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 3: Contact Information -->
      <div *ngIf="currentStep === 3" class="form-step">
        <h2 class="step-title">معلومات الاتصال</h2>
        <div class="form-section">
        <div class="form-row">
          <div class="form-group col-6">
            <label for="contactEmail">البريد الإلكتروني</label>
            <input
              type="email"
              id="contactEmail"
              formControlName="contactEmail"
              [class.invalid]="isFieldInvalid('contactEmail')"
              placeholder="example@domain.com"
            />
            <div class="error-message" *ngIf="isFieldInvalid('contactEmail')">
              بريد إلكتروني صحيح مطلوب
            </div>
          </div>

          <div class="form-group col-6">
            <label for="contactPhone">رقم الهاتف</label>
            <input
              type="tel"
              id="contactPhone"
              formControlName="contactPhone"
              placeholder="رقم الهاتف"
            />
          </div>
        </div>
        </div>
      </div>

      <!-- Step 4: Questions -->
      <div *ngIf="currentStep === 4" class="form-step">
        <h2 class="step-title">الأسئلة</h2>
        <div class="form-section" *ngIf="loadingQuestions">
          <div class="loading-questions">
            <div class="spinner"></div>
            <p>جاري تحميل الأسئلة...</p>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length > 0">
          <div class="questions-container" [formGroup]="questionsForm">
            <app-dynamic-question
              *ngFor="let question of sortedQuestions; trackBy: trackByQuestionId"
              [question]="question"
              [formControlName]="'question_' + question.id"
            ></app-dynamic-question>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length === 0 && violationForm.get('categoryId')?.value">
          <div class="empty-questions-message">
            <p>لا توجد أسئلة لهذه الفئة</p>
          </div>
        </div>

        <div class="form-section" *ngIf="!loadingQuestions && sortedQuestions.length === 0 && !violationForm.get('categoryId')?.value">
          <div class="empty-questions-message">
            <p>يرجى اختيار الفئة أولاً</p>
          </div>
        </div>
      </div>

      <!-- Step 5: Attachments -->
      <div *ngIf="currentStep === 5" class="form-step">
        <h2 class="step-title">المرفقات</h2>
        <div class="form-section">
        <div class="file-upload-area">
          <input
            type="file"
            id="fileInput"
            multiple
            accept="image/*,video/*,.pdf,.doc,.docx"
            (change)="onFileSelected($event)"
            style="display: none;"
            #fileInput
          />
          <button type="button" class="btn-secondary" (click)="fileInput.click()">
            <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
            إضافة مرفقات
          </button>
        </div>

        <div class="attachments-preview" *ngIf="attachmentPreviews.length > 0">
          <div *ngFor="let preview of attachmentPreviews; let i = index" class="attachment-preview-item">
            <img
              *ngIf="isImage(preview.file?.type || '')"
              [src]="preview.preview"
              [alt]="preview.file?.name || 'attachment'"
              class="attachment-image"
            />
            <div *ngIf="!isImage(preview.file?.type || '')" class="attachment-file-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>{{ preview.file?.name || 'ملف' }}</span>
            </div>
            <button
              type="button"
              class="remove-attachment"
              (click)="removeAttachment(i)"
              title="إزالة"
            >
              ×
            </button>
          </div>
        </div>
        </div>
      </div>

      <!-- Step 6: Review -->
      <div *ngIf="currentStep === 6" class="form-step">
        <h2 class="step-title">المراجعة والإرسال</h2>
        <p class="step-description">يرجى مراجعة المعلومات قبل الإرسال</p>
        
        <!-- Current Form Data Review -->
        <div class="review-section">
          <h3 class="review-card-title">البيانات الحالية</h3>
          <div class="review-grid">
            <div class="review-item">
              <div class="review-label">
                <strong>المدينة:</strong>
              </div>
              <div class="review-value">{{ getSelectedCityName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة:</strong>
              </div>
              <div class="review-value">{{ getSelectedCategoryName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة الفرعية:</strong>
              </div>
              <div class="review-value">{{ getSelectedSubCategoryName() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>تاريخ الحادثة:</strong>
              </div>
              <div class="review-value">{{ getViolationDateValue() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الموقع:</strong>
              </div>
              <div class="review-value">{{ getLocationValue() }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الصفة:</strong>
              </div>
              <div class="review-value">{{ getRoleValue() }}</div>
            </div>
            <div class="review-item" *ngIf="getOtherRoleTextValue()">
              <div class="review-label">
                <strong>تحديد الصفة:</strong>
              </div>
              <div class="review-value">{{ getOtherRoleTextValue() }}</div>
            </div>
            <div class="review-item review-item-full">
              <div class="review-label">
                <strong>الوصف:</strong>
              </div>
              <div class="review-value review-description">{{ getDescriptionValue() }}</div>
            </div>
            <!-- Personal/Victim Information -->
            <div class="review-item" *ngIf="violationForm.get('personalName')?.value">
              <div class="review-label">
                <strong>اسم الضحية:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalName')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalCity')?.value">
              <div class="review-label">
                <strong>مدينة الإقامة:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalCity')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalAddress')?.value">
              <div class="review-label">
                <strong>العنوان:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalAddress')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalAge')?.value">
              <div class="review-label">
                <strong>العمر:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalAge')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalDateOfBirth')?.value">
              <div class="review-label">
                <strong>تاريخ الميلاد:</strong>
              </div>
              <div class="review-value">{{ getPersonalDateOfBirthValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('personalEducation')?.value">
              <div class="review-label">
                <strong>المستوى التعليمي:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('personalEducation')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('gender')?.value">
              <div class="review-label">
                <strong>الجنس:</strong>
              </div>
              <div class="review-value">{{ getGenderValue() }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('maritalStatus')?.value">
              <div class="review-label">
                <strong>الحالة الاجتماعية:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('maritalStatus')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('work')?.value">
              <div class="review-label">
                <strong>العمل:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('work')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('hasDisability')?.value">
              <div class="review-label">
                <strong>لديه إعاقة:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('hasDisability')?.value ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('disabilityType')?.value">
              <div class="review-label">
                <strong>نوع الإعاقة:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('disabilityType')?.value }}</div>
            </div>
            <!-- Contact Information -->
            <div class="review-item" *ngIf="violationForm.get('contactEmail')?.value">
              <div class="review-label">
                <strong>البريد الإلكتروني:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactEmail')?.value }}</div>
            </div>
            <div class="review-item" *ngIf="violationForm.get('contactPhone')?.value">
              <div class="review-label">
                <strong>رقم الهاتف:</strong>
              </div>
              <div class="review-value">{{ violationForm.get('contactPhone')?.value }}</div>
            </div>
            <!-- Question Answers -->
            <div class="review-item review-item-full" *ngIf="sortedQuestions.length > 0">
              <div class="review-label">
                <strong>الإجابات على الأسئلة:</strong>
              </div>
              <div class="review-value">
                <div class="question-answers-list">
                  <div *ngFor="let question of sortedQuestions" class="question-answer-item">
                    <div class="question-text">{{ question.text }}</div>
                    <div class="answer-value" *ngIf="hasQuestionAnswer(question.id)">
                      {{ getQuestionAnswerValue(question.id) }}
                    </div>
                    <div class="answer-value no-answer" *ngIf="!hasQuestionAnswer(question.id)">
                      لا توجد إجابة
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>عرض المعلومات الشخصية عند النشر:</strong>
              </div>
              <div class="review-value">{{ (violationForm.get('showPersonalInfoInPublish')?.value) ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="attachmentPreviews.length > 0">
              <div class="review-label">
                <strong>عدد المرفقات:</strong>
              </div>
              <div class="review-value">{{ attachmentPreviews.length }}</div>
            </div>
          </div>
        </div>
        
        <!-- Original Data (only when editing and data has changed) -->
        <div *ngIf="editingViolation && originalViolationData && hasDataChanged()" class="review-section original-data">
          <h3 class="review-card-title">البيانات الأصلية (قبل التعديل)</h3>
          <div class="review-grid">
            <div class="review-item">
              <div class="review-label">
                <strong>المدينة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.cityName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.categoryName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الفئة الفرعية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.subCategoryName || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>تاريخ الحادثة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.violationDate | date:'medium' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الموقع:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.location || 'غير محدد' }}</div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>الصفة:</strong>
              </div>
              <div class="review-value">{{ getPrivateViolationRoleLabel(originalViolationData.role) }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.otherRoleText">
              <div class="review-label">
                <strong>تحديد الصفة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.otherRoleText }}</div>
            </div>
            <div class="review-item review-item-full">
              <div class="review-label">
                <strong>الوصف:</strong>
              </div>
              <div class="review-value review-description">{{ originalViolationData.description || 'لا يوجد وصف' }}</div>
            </div>
            <!-- Personal/Victim Information -->
            <div class="review-item" *ngIf="originalViolationData.personalName">
              <div class="review-label">
                <strong>اسم الضحية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalName }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalCity">
              <div class="review-label">
                <strong>مدينة الإقامة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalCity }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalAddress">
              <div class="review-label">
                <strong>العنوان:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalAddress }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalAge">
              <div class="review-label">
                <strong>العمر:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalAge }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalDateOfBirth">
              <div class="review-label">
                <strong>تاريخ الميلاد:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalDateOfBirth | date:'medium' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.personalEducation">
              <div class="review-label">
                <strong>المستوى التعليمي:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.personalEducation }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.gender">
              <div class="review-label">
                <strong>الجنس:</strong>
              </div>
              <div class="review-value">{{ getGenderLabel(originalViolationData.gender) }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.maritalStatus">
              <div class="review-label">
                <strong>الحالة الاجتماعية:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.maritalStatus }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.work">
              <div class="review-label">
                <strong>العمل:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.work }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.hasDisability">
              <div class="review-label">
                <strong>لديه إعاقة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.hasDisability ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.disabilityType">
              <div class="review-label">
                <strong>نوع الإعاقة:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.disabilityType }}</div>
            </div>
            <!-- Contact Information -->
            <div class="review-item" *ngIf="originalViolationData.contactEmail">
              <div class="review-label">
                <strong>البريد الإلكتروني:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactEmail }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.contactPhone">
              <div class="review-label">
                <strong>رقم الهاتف:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.contactPhone }}</div>
            </div>
            <!-- Question Answers -->
            <div class="review-item review-item-full" *ngIf="originalViolationData.questionAnswers && originalViolationData.questionAnswers.length > 0">
              <div class="review-label">
                <strong>الإجابات على الأسئلة:</strong>
              </div>
              <div class="review-value">
                <div class="question-answers-list">
                  <div *ngFor="let answer of originalViolationData.questionAnswers" class="question-answer-item">
                    <div class="question-text">{{ answer.questionText || 'سؤال #' + answer.questionId }}</div>
                    <div class="answer-value">{{ answer.answerValue || 'لا توجد إجابة' }}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="review-item">
              <div class="review-label">
                <strong>عرض المعلومات الشخصية عند النشر:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.showPersonalInfoInPublish ? 'نعم' : 'لا' }}</div>
            </div>
            <div class="review-item" *ngIf="originalViolationData.attachments && originalViolationData.attachments.length > 0">
              <div class="review-label">
                <strong>عدد المرفقات:</strong>
              </div>
              <div class="review-value">{{ originalViolationData.attachments.length }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button
          type="button"
          class="btn-secondary"
          (click)="previousStep()"
          [disabled]="currentStep === 1"
        >
          السابق
        </button>
        <button
          *ngIf="currentStep < totalSteps"
          type="button"
          class="btn-primary"
          (click)="nextStep()"
        >
          التالي
        </button>
        <button
          *ngIf="currentStep === totalSteps"
          type="button"
          class="btn-primary"
          (click)="saveViolation()"
          [disabled]="loading"
        >
          {{ editingViolation ? 'حفظ التغييرات' : 'إضافة' }}
        </button>
        <button
          type="button"
          class="btn-secondary"
          (click)="closeModal()"
        >
          إلغاء
        </button>
      </div>
    </form>
  </app-modal>

  <!-- Details Modal -->
  <app-modal
    [show]="showDetailsModal"
    title="تفاصيل البلاغ"
    size="lg"
    (close)="closeDetailsModal()"
  >
    <div *ngIf="selectedViolation" class="violation-details">
      <div class="details-section">
        <h3 class="section-title">المعلومات الأساسية</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">رقم البلاغ:</span>
            <span class="detail-value">#{{ selectedViolation.id }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">المدينة:</span>
            <span class="detail-value">{{ selectedViolation.cityName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الفئة:</span>
            <span class="detail-value">{{ selectedViolation.categoryName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الفئة الفرعية:</span>
            <span class="detail-value">{{ selectedViolation.subCategoryName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">تاريخ الحادثة:</span>
            <span class="detail-value">{{ selectedViolation.violationDate | date:'medium' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الموقع:</span>
            <span class="detail-value">{{ selectedViolation.location || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الصفة:</span>
            <span class="detail-value">{{ getPrivateViolationRoleLabel(selectedViolation.role) }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.otherRoleText">
            <span class="detail-label">تحديد الصفة:</span>
            <span class="detail-value">{{ selectedViolation.otherRoleText }}</span>
          </div>
          <div class="detail-item full-width">
            <span class="detail-label">الوصف:</span>
            <span class="detail-value">{{ selectedViolation.description || 'لا يوجد وصف' }}</span>
          </div>
        </div>
      </div>

      <!-- Personal Information -->
      <div class="details-section" *ngIf="selectedViolation.personalName || selectedViolation.personalCity">
        <h3 class="section-title">معلومات الضحية/الشخص</h3>
        <div class="details-grid">
          <div class="detail-item" *ngIf="selectedViolation.personalName">
            <span class="detail-label">الاسم:</span>
            <span class="detail-value">{{ selectedViolation.personalName }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.personalCity">
            <span class="detail-label">مدينة الإقامة:</span>
            <span class="detail-value">{{ selectedViolation.personalCity }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.personalAddress">
            <span class="detail-label">العنوان:</span>
            <span class="detail-value">{{ selectedViolation.personalAddress }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.personalAge">
            <span class="detail-label">العمر:</span>
            <span class="detail-value">{{ selectedViolation.personalAge }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.personalDateOfBirth">
            <span class="detail-label">تاريخ الميلاد:</span>
            <span class="detail-value">{{ selectedViolation.personalDateOfBirth | date:'medium' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.personalEducation">
            <span class="detail-label">المستوى التعليمي:</span>
            <span class="detail-value">{{ selectedViolation.personalEducation }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.gender">
            <span class="detail-label">الجنس:</span>
            <span class="detail-value">{{ getGenderLabel(selectedViolation.gender) }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.maritalStatus">
            <span class="detail-label">الحالة الاجتماعية:</span>
            <span class="detail-value">{{ selectedViolation.maritalStatus }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.work">
            <span class="detail-label">العمل:</span>
            <span class="detail-value">{{ selectedViolation.work }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.hasDisability">
            <span class="detail-label">لديه إعاقة:</span>
            <span class="detail-value">{{ selectedViolation.hasDisability ? 'نعم' : 'لا' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.disabilityType">
            <span class="detail-label">نوع الإعاقة:</span>
            <span class="detail-value">{{ selectedViolation.disabilityType }}</span>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="details-section" *ngIf="selectedViolation.contactEmail || selectedViolation.contactPhone">
        <h3 class="section-title">معلومات الاتصال</h3>
        <div class="details-grid">
          <div class="detail-item" *ngIf="selectedViolation.contactEmail">
            <span class="detail-label">البريد الإلكتروني:</span>
            <span class="detail-value">{{ selectedViolation.contactEmail }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.contactPhone">
            <span class="detail-label">رقم الهاتف:</span>
            <span class="detail-value">{{ selectedViolation.contactPhone }}</span>
          </div>
        </div>
      </div>

      <!-- Question Answers -->
      <div class="details-section" *ngIf="selectedViolation.questionAnswers && selectedViolation.questionAnswers.length > 0">
        <h3 class="section-title">الإجابات على الأسئلة</h3>
        <div class="question-answers-list">
          <div *ngFor="let answer of selectedViolation.questionAnswers" class="question-answer-item">
            <div class="question-text">{{ answer.questionText || 'سؤال #' + answer.questionId }}</div>
            <div class="answer-value">{{ answer.answerValue || 'لا توجد إجابة' }}</div>
          </div>
        </div>
      </div>

      <!-- Attachments -->
      <div class="details-section" *ngIf="selectedViolation.attachments && selectedViolation.attachments.length > 0">
        <h3 class="section-title">المرفقات</h3>
        <div class="attachments-grid">
          <div *ngFor="let attachment of selectedViolation.attachments" class="attachment-item">
            <img 
              *ngIf="isImage(attachment.fileType)" 
              [src]="getAttachmentUrl(attachment.filePath)" 
              [alt]="attachment.fileName"
              (click)="openAttachment(attachment.filePath)"
              class="attachment-image"
            />
            <div 
              *ngIf="!isImage(attachment.fileType)" 
              class="attachment-file"
              (click)="openAttachment(attachment.filePath)"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <span>{{ attachment.fileName }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Information -->
      <div class="details-section">
        <h3 class="section-title">حالة البلاغ</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">حالة الموافقة:</span>
            <span class="detail-badge" 
              [class.badge-pending]="selectedViolation.acceptanceStatus === AcceptanceStatus.Pending" 
              [class.badge-approved]="selectedViolation.acceptanceStatus === AcceptanceStatus.Approved" 
              [class.badge-rejected]="selectedViolation.acceptanceStatus === AcceptanceStatus.Rejected">
              {{ getAcceptanceStatusLabel(selectedViolation.acceptanceStatus) }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">حالة النشر:</span>
            <span class="detail-badge" 
              [class.badge-published]="selectedViolation.publishStatus === PublishStatus.Publish" 
              [class.badge-unpublished]="selectedViolation.publishStatus === PublishStatus.NotPublish">
              {{ getPublishStatusLabel(selectedViolation.publishStatus) }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">عرض المعلومات الشخصية عند النشر:</span>
            <span class="detail-value">{{ selectedViolation.showPersonalInfoInPublish ? 'نعم' : 'لا' }}</span>
          </div>
        </div>
      </div>

      <!-- Additional Information -->
      <div class="details-section">
        <h3 class="section-title">معلومات إضافية</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">تاريخ الإنشاء:</span>
            <span class="detail-value">{{ selectedViolation.creationDate | date:'medium' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.createdByUserName">
            <span class="detail-label">أنشئ بواسطة:</span>
            <span class="detail-value">{{ selectedViolation.createdByUserName }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div footer>
      <button type="button" class="btn-secondary" (click)="closeDetailsModal()">
        إغلاق
      </button>
    </div>
  </app-modal>
</div>
