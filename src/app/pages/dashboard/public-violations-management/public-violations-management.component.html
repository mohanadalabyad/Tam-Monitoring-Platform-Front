<div class="public-violations-management-page">
  <div class="page-header">
    <div>
      <h1>إدارة البلاغات العامة</h1>
      <p>إدارة وعرض جميع البلاغات العامة</p>
    </div>
    <div class="header-actions">
      <app-view-toggle
        [storageKey]="'public-violations-view-mode'"
        [defaultView]="'table'"
        (viewChange)="onViewChange($event)"
      ></app-view-toggle>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" *hasPermission="'PublicViolation.Read'">
    <div class="filters-header" (click)="showFilters = !showFilters">
      <span>التصفية</span>
      <svg [class.rotated]="showFilters" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 9l6 6 6-6"/>
      </svg>
    </div>
    <div class="filters-content" *ngIf="showFilters">
      <form [formGroup]="filterForm">
        <div class="filters-grid">
          <div class="filter-group">
            <label for="verificationStatus">حالة التوثيق:</label>
            <select id="verificationStatus" formControlName="verificationStatus">
              <option [ngValue]="null">جميع الحالات</option>
              <option [ngValue]="1">غير موثق</option>
              <option [ngValue]="2">موثق</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="publishStatus">حالة النشر:</label>
            <select id="publishStatus" formControlName="publishStatus">
              <option [ngValue]="null">جميع الحالات</option>
              <option [ngValue]="1">منشور</option>
              <option [ngValue]="2">غير منشور</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="violationType">صفة المبلغ:</label>
            <select id="violationType" formControlName="violationType">
              <option [ngValue]="null">الكل</option>
              <option [ngValue]="1">المبلغ</option>
              <option [ngValue]="2">شاهد</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="cityId">المدينة:</label>
            <select id="cityId" formControlName="cityId" [disabled]="loadingCities">
              <option [value]="null">جميع المدن</option>
              <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="categoryId">الفئة:</label>
            <select id="categoryId" formControlName="categoryId" [disabled]="loadingCategories">
              <option [value]="null">جميع الفئات</option>
              <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="subCategoryId">الفئة الفرعية:</label>
            <select id="subCategoryId" formControlName="subCategoryId" [disabled]="loadingSubCategories || !filterForm.get('categoryId')?.value">
              <option [value]="null">جميع الفئات الفرعية</option>
              <option *ngFor="let subCategory of subCategories" [value]="subCategory.id">{{ subCategory.name }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="perpetratorTypeId">مرتكب الانتهاك:</label>
            <select id="perpetratorTypeId" formControlName="perpetratorTypeId" [disabled]="loadingPerpetratorTypes || !filterForm.get('categoryId')?.value">
              <option [value]="null">الكل</option>
              <option *ngFor="let pt of perpetratorTypes" [value]="pt.id">{{ pt.name }}</option>
            </select>
          </div>
        </div>

        <div class="filters-actions">
          <button type="button" class="btn-secondary" (click)="resetFilters()">
            إعادة تعيين
          </button>
          <button type="button" class="btn-primary" (click)="applyFilters()">
            تطبيق التصفية
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Table View -->
  <div *ngIf="viewMode === 'table'">
    <app-unified-table
      [columns]="columns"
      [data]="searchTerm ? filteredViolations : publicViolations"
      [loading]="loading"
      [actions]="actions"
      [pageSize]="pageSize"
      [serverSidePagination]="!searchTerm"
      [currentPageNumber]="currentPage"
      [totalPagesCount]="totalPages"
      [totalCount]="searchTerm ? filteredViolations.length : totalCount"
      emptyMessage="لا توجد بلاغات عامة"
      (rowClick)="viewDetails($event)"
      (pageChange)="onPageChange($event)"
      (searchChange)="onSearchChange($event)"
    ></app-unified-table>
  </div>

  <!-- Cards View -->
  <div *ngIf="viewMode === 'cards'" class="violations-cards-view">
    <!-- Search Box for Cards View -->
    <div class="cards-search-box" *ngIf="viewMode === 'cards'">
      <div class="search-box">
        <input
          type="text"
          [value]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="بحث في البلاغات..."
          class="search-input"
        />
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </div>
    </div>
    
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>جاري تحميل البلاغات...</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : publicViolations).length === 0" class="empty-state">
      <p>{{ searchTerm ? 'لا توجد نتائج للبحث' : 'لا توجد بلاغات عامة' }}</p>
    </div>
    <div *ngIf="!loading && (searchTerm ? filteredViolations : publicViolations).length > 0" class="violations-grid">
      <div *ngFor="let violation of (searchTerm ? filteredViolations : publicViolations)" class="violation-card">
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">بلاغ #{{ violation.id }}</h3>
            <div class="card-badges">
              <span class="card-badge" [class.badge-verified]="violation.verificationStatus === 2" [class.badge-unverified]="violation.verificationStatus === 1">
                {{ getVerificationStatusLabel(violation.verificationStatus) }}
              </span>
              <span class="card-badge" [class.badge-published]="violation.publishStatus === 1" [class.badge-unpublished]="violation.publishStatus === 2">
                {{ getPublishStatusLabel(violation.publishStatus) }}
              </span>
            </div>
          </div>
          <div class="card-actions-header">
            <button
              *ngIf="permissionService.hasPermission('PublicViolation.Read') || permissionService.isSuperAdmin()"
              type="button"
              class="card-action-icon btn-view"
              (click)="viewDetails(violation); $event.stopPropagation()"
              title="عرض التفاصيل"
            >
              <lucide-icon [img]="Eye" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="permissionService.hasPermission('PublicViolation.Update') || permissionService.isSuperAdmin()"
              type="button"
              class="card-action-icon btn-edit"
              (click)="editDescription(violation); $event.stopPropagation()"
              title="تعديل الوصف"
            >
              <lucide-icon [img]="Pencil" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="permissionService.hasPermission('ViolationFollowUp.Create') || permissionService.isSuperAdmin()"
              type="button"
              class="card-action-icon btn-info"
              (click)="openFollowUpModal(violation); $event.stopPropagation()"
              title="إضافة Follow-up"
            >
              <lucide-icon [img]="ClipboardList" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="(permissionService.hasPermission('PublicViolation.Verify') || permissionService.isSuperAdmin()) && violation.verificationStatus === 1"
              type="button"
              class="card-action-icon btn-verify"
              (click)="verifyViolation(violation); $event.stopPropagation()"
              title="توثيق"
            >
              <lucide-icon [img]="CheckCircle" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="(permissionService.hasPermission('PublicViolation.Verify') || permissionService.isSuperAdmin()) && violation.verificationStatus === 2"
              type="button"
              class="card-action-icon btn-unverify"
              (click)="unverifyViolation(violation); $event.stopPropagation()"
              title="إلغاء التوثيق"
            >
              <lucide-icon [img]="XCircle" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="(permissionService.hasPermission('PublicViolation.Publish') || permissionService.isSuperAdmin()) && violation.publishStatus === 2"
              type="button"
              class="card-action-icon btn-publish"
              (click)="publishViolation(violation); $event.stopPropagation()"
              title="نشر"
            >
              <lucide-icon [img]="Upload" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="(permissionService.hasPermission('PublicViolation.Publish') || permissionService.isSuperAdmin()) && violation.publishStatus === 1"
              type="button"
              class="card-action-icon btn-unpublish"
              (click)="unpublishViolation(violation); $event.stopPropagation()"
              title="إلغاء النشر"
            >
              <lucide-icon [img]="Download" [size]="16"></lucide-icon>
            </button>
            <button
              *ngIf="permissionService.hasPermission('PublicViolation.Delete') || permissionService.isSuperAdmin()"
              type="button"
              class="card-action-icon btn-delete"
              (click)="deleteViolation(violation); $event.stopPropagation()"
              title="حذف"
            >
              <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
            </button>
          </div>
        </div>
        <div class="card-content">
          <div class="card-field">
            <span class="field-label">المدينة:</span>
            <span class="field-value">{{ violation.cityName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة:</span>
            <span class="field-value">{{ violation.categoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الفئة الفرعية:</span>
            <span class="field-value">{{ violation.subCategoryName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">مرتكب الانتهاك:</span>
            <span class="field-value">{{ violation.perpetratorTypeName || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">صفة المبلغ:</span>
            <span class="field-value">{{ getViolationTypeLabel(violation.violationType) }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">تاريخ الحادثة:</span>
            <span class="field-value">{{ violation.violationDate | date:'mediumDate' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">العنوان:</span>
            <span class="field-value">{{ violation.address || 'غير محدد' }}</span>
          </div>
          <div class="card-field">
            <span class="field-label">الوصف:</span>
            <span class="field-value">{{ violation.description || 'لا يوجد وصف' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Description Modal -->
  <app-modal
    [show]="showModal"
    [title]="modalTitle"
    size="md"
    (close)="closeModal()"
  >
    <form [formGroup]="descriptionForm">
      <div class="form-group">
        <label for="description">الوصف *</label>
        <textarea
          id="description"
          formControlName="description"
          [class.invalid]="isFieldInvalid('description')"
          placeholder="أدخل وصف البلاغ"
          rows="6"
        ></textarea>
        <div class="error-message" *ngIf="isFieldInvalid('description')">
          الوصف مطلوب
        </div>
      </div>
      <div class="form-group">
        <label for="publishDescription">وصف النشر</label>
        <textarea
          id="publishDescription"
          formControlName="publishDescription"
          placeholder="وصف يُعرض عند النشر (اختياري)"
          rows="4"
        ></textarea>
      </div>
    </form>
    
    <div footer>
      <button type="button" class="btn-secondary" (click)="closeModal()">
        إلغاء
      </button>
      <button type="button" class="btn-primary" (click)="updateDescription()">
        حفظ التغييرات
      </button>
    </div>
  </app-modal>

  <!-- Details Modal -->
  <app-modal
    [show]="showDetailsModal"
    title="تفاصيل البلاغ"
    size="lg"
    (close)="closeDetailsModal()"
  >
    <div *ngIf="selectedViolation" class="violation-details">
      <div class="details-section">
        <h3 class="section-title">المعلومات الأساسية</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">رقم البلاغ:</span>
            <span class="detail-value">#{{ selectedViolation.id }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">المدينة:</span>
            <span class="detail-value">{{ selectedViolation.cityName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الفئة:</span>
            <span class="detail-value">{{ selectedViolation.categoryName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الفئة الفرعية:</span>
            <span class="detail-value">{{ selectedViolation.subCategoryName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">مرتكب الانتهاك:</span>
            <span class="detail-value">{{ selectedViolation.perpetratorTypeName || 'غير محدد' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">صفة المبلغ:</span>
            <span class="detail-value">{{ getViolationTypeLabel(selectedViolation.violationType) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">تاريخ الحادثة:</span>
            <span class="detail-value">{{ selectedViolation.violationDate | date:'mediumDate' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">العنوان:</span>
            <span class="detail-value">{{ selectedViolation.address || 'غير محدد' }}</span>
          </div>
          <div class="detail-item full-width">
            <span class="detail-label">الوصف:</span>
            <span class="detail-value">{{ selectedViolation.description || 'لا يوجد وصف' }}</span>
          </div>
          <div class="detail-item full-width" *ngIf="selectedViolation.publishDescription">
            <span class="detail-label">وصف النشر:</span>
            <span class="detail-value">{{ selectedViolation.publishDescription }}</span>
          </div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">حالة البلاغ</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">حالة التوثيق:</span>
            <span class="detail-badge" [class.badge-verified]="selectedViolation.verificationStatus === 2" [class.badge-unverified]="selectedViolation.verificationStatus === 1">
              {{ getVerificationStatusLabel(selectedViolation.verificationStatus) }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">حالة النشر:</span>
            <span class="detail-badge" [class.badge-published]="selectedViolation.publishStatus === 1" [class.badge-unpublished]="selectedViolation.publishStatus === 2">
              {{ getPublishStatusLabel(selectedViolation.publishStatus) }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الحالة:</span>
            <span class="detail-badge" [class.badge-active]="selectedViolation.isActive" [class.badge-inactive]="!selectedViolation.isActive">
              {{ selectedViolation.isActive ? 'نشط' : 'غير نشط' }}
            </span>
          </div>
        </div>
      </div>

      <div class="details-section" *ngIf="selectedViolation.canContact && (selectedViolation.email || selectedViolation.phoneNumber)">
        <h3 class="section-title">معلومات الاتصال</h3>
        <div class="details-grid">
          <div class="detail-item" *ngIf="selectedViolation.email">
            <span class="detail-label">البريد الإلكتروني:</span>
            <span class="detail-value">{{ selectedViolation.email }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.phoneNumber">
            <span class="detail-label">رقم الهاتف:</span>
            <span class="detail-value">{{ selectedViolation.phoneNumber }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.preferredContactMethod">
            <span class="detail-label">الطريقة المفضلة:</span>
            <span class="detail-value">{{ getPreferredContactLabel(selectedViolation.preferredContactMethod) }}</span>
          </div>
        </div>
      </div>

      <div class="details-section" *ngIf="selectedViolation.attachments && selectedViolation.attachments.length > 0">
        <h3 class="section-title">المرفقات</h3>
        <div class="attachments-grid">
          <div *ngFor="let attachment of selectedViolation.attachments" class="attachment-item">
            <img 
              *ngIf="isImage(attachment.fileType)" 
              [src]="getAttachmentUrl(attachment.filePath)" 
              [alt]="attachment.fileName"
              (click)="openAttachment(attachment.filePath)"
              class="attachment-image"
            />
            <video 
              *ngIf="isVideo(attachment.fileType)" 
              [src]="getAttachmentUrl(attachment.filePath)" 
              controls
              class="attachment-video"
              (click)="$event.stopPropagation()"
            ></video>
            <div 
              *ngIf="!isImage(attachment.fileType) && !isVideo(attachment.fileType)" 
              class="attachment-file"
              (click)="openAttachment(attachment.filePath)"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <span>{{ attachment.fileName }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">معلومات إضافية</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">تاريخ الإنشاء:</span>
            <span class="detail-value">{{ selectedViolation.creationDate | date:'mediumDate' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedViolation.createdBy">
            <span class="detail-label">أنشئ بواسطة:</span>
            <span class="detail-value">{{ selectedViolation.createdBy }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div footer>
      <button type="button" class="btn-secondary" (click)="closeDetailsModal()">
        إغلاق
      </button>
      <button 
        *ngIf="permissionService.hasPermission('PublicViolation.Update') || permissionService.isSuperAdmin()"
        type="button" 
        class="btn-primary" 
        (click)="closeDetailsModal(); editDescription(selectedViolation!)"
      >
        تعديل الوصف
      </button>
    </div>
  </app-modal>

  <!-- Follow-Up Modal -->
  <app-modal
    [show]="showFollowUpModal"
    title="إضافة Follow-up"
    size="lg"
    (close)="closeFollowUpModal()"
  >
    <div *ngIf="selectedViolationForFollowUp">
      <!-- Follow-Up History -->
      <div class="follow-up-history" *ngIf="followUps.length > 0">
        <h3 class="section-title">سجل المتابعة</h3>
        <div class="history-list" *ngIf="!loadingFollowUps">
          <div *ngFor="let followUp of followUps" class="history-item">
            <div class="history-header">
              <span class="history-status">{{ followUp.followUpStatusName }}</span>
              <span class="history-date">{{ followUp.creationDate | date:'mediumDate' }}</span>
            </div>
            <div class="history-note">{{ followUp.note }}</div>
            <div class="history-attachments" *ngIf="followUp.attachments && followUp.attachments.length > 0">
              <span class="history-attachments-label">المرفقات:</span>
              <div class="history-attachments-grid">
                <div *ngFor="let att of followUp.attachments" class="history-attachment-item">
                  <a (click)="openAttachment(att.filePath)" href="javascript:void(0)" target="_blank" rel="noopener noreferrer">
                    <img *ngIf="isImage(att.fileType)" class="history-attachment-image" [src]="getAttachmentUrl(att.filePath)" [alt]="att.fileName" />
                    <div *ngIf="!isImage(att.fileType)" class="history-attachment-file">
                      <span>{{ att.fileName }}</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
            <div class="history-user">بواسطة: {{ followUp.createdByUserName || 'غير معروف' }}</div>
          </div>
        </div>
        <div *ngIf="loadingFollowUps" class="loading-state">
          <div class="spinner"></div>
          <p>جاري تحميل سجل المتابعة...</p>
        </div>
      </div>

      <!-- Add New Follow-Up Form -->
      <div class="follow-up-form">
        <h3 class="section-title">إضافة Follow-up جديد</h3>
        <form [formGroup]="followUpForm">
          <div class="form-group">
            <label for="followUpStatusId">حالة المتابعة *</label>
            <select
              id="followUpStatusId"
              formControlName="followUpStatusId"
              class="form-control"
              [class.invalid]="followUpForm.get('followUpStatusId')?.invalid && followUpForm.get('followUpStatusId')?.touched"
            >
              <option [ngValue]="null">اختر حالة المتابعة</option>
              <option *ngFor="let status of followUpStatuses" [ngValue]="status.id">
                {{ status.name }}
              </option>
            </select>
            <div class="error-message" *ngIf="followUpForm.get('followUpStatusId')?.invalid && followUpForm.get('followUpStatusId')?.touched">
              حالة المتابعة مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label for="note">الملاحظة *</label>
            <textarea
              id="note"
              formControlName="note"
              placeholder="أدخل الملاحظة"
              rows="4"
              class="form-control"
              [class.invalid]="followUpForm.get('note')?.invalid && followUpForm.get('note')?.touched"
            ></textarea>
            <div class="error-message" *ngIf="followUpForm.get('note')?.invalid && followUpForm.get('note')?.touched">
              الملاحظة مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label>مرفقات (اختياري، حد أقصى 100 ميجابايت للملف)</label>
            <input
              type="file"
              #followUpFileInput
              multiple
              accept="image/*,video/*,.pdf,.doc,.docx"
              (change)="onFollowUpFileSelected($event)"
              style="display: none;"
            />
            <button type="button" class="btn-secondary" (click)="followUpFileInput.click()">
              إضافة مرفقات
            </button>
            <div class="follow-up-attachments-list" *ngIf="followUpAttachments.length > 0">
              <span *ngFor="let f of followUpAttachments; let i = index" class="follow-up-attachment-tag">
                {{ f.name }}
                <button type="button" class="remove-follow-up-attachment" (click)="removeFollowUpAttachment(i)" title="إزالة">×</button>
              </span>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <div footer>
      <button type="button" class="btn-secondary" (click)="closeFollowUpModal()">
        إغلاق
      </button>
      <button type="button" class="btn-primary" (click)="saveFollowUp()" [disabled]="loading || followUpForm.invalid">
        <span *ngIf="loading">جاري الحفظ...</span>
        <span *ngIf="!loading">حفظ</span>
      </button>
    </div>
  </app-modal>
</div>
