<div class="report-violation">
  <div class="container">
    <div class="page-header">
      <h1>الإبلاغ عن حادثة</h1>
      <p>ساعدنا في الحفاظ على سلامة المجتمع من خلال الإبلاغ عن الحوادث</p>
    </div>

    <!-- Success Message -->
    <div *ngIf="submitted && !submitting" class="success-card">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <h2>تم الإرسال بنجاح!</h2>
      <p>تم إرسال تقريرك بنجاح. رقم التقرير: <strong>#{{ submittedViolationId }}</strong></p>
      <div class="success-actions">
        <button class="btn-outline" (click)="resetForm()">إرسال تقرير آخر</button>
      </div>
    </div>


    <!-- Multi-Step Form -->
    <div *ngIf="!submitted" class="form-card" [formGroup]="violationForm">
      <!-- Progress Steps -->
      <div class="steps-indicator">
        <div 
          *ngFor="let step of [1,2,3,4]; let i = index" 
          class="step-item"
          [class.active]="currentStep === step"
          [class.completed]="currentStep > step"
          (click)="goToStep(step)"
        >
          <div class="step-number">{{ step }}</div>
          <div class="step-label">
            <span *ngIf="step === 1">المعلومات الأساسية</span>
            <span *ngIf="step === 2">معلومات الاتصال</span>
            <span *ngIf="step === 3">المرفقات</span>
            <span *ngIf="step === 4">المراجعة والإرسال</span>
          </div>
        </div>
      </div>

      <!-- Step 1: Basic Information -->
      <div *ngIf="currentStep === 1" class="form-step">
        <h2 class="step-title">المعلومات الأساسية</h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="cityId">المدينة *</label>
            <select
              id="cityId"
              formControlName="cityId"
              [class.invalid]="isFieldInvalid(violationForm, 'cityId')"
            >
              <option value="">اختر المدينة</option>
              <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'cityId')">
              المدينة مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label for="categoryId">الفئة *</label>
            <select
              id="categoryId"
              formControlName="categoryId"
              [class.invalid]="isFieldInvalid(violationForm, 'categoryId')"
              (change)="onCategoryChange($any($event.target).value)"
            >
              <option value="">اختر الفئة</option>
              <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'categoryId')">
              الفئة مطلوبة
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="subCategoryId">الفئة الفرعية *</label>
            <select
              id="subCategoryId"
              formControlName="subCategoryId"
              [class.invalid]="isFieldInvalid(violationForm, 'subCategoryId')"
              [disabled]="filteredSubCategories.length === 0"
            >
              <option value="">اختر الفئة الفرعية</option>
              <option *ngFor="let subCategory of filteredSubCategories" [value]="subCategory.id">{{ subCategory.name }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'subCategoryId')">
              الفئة الفرعية مطلوبة
            </div>
          </div>

          <div class="form-group">
            <label for="perpetratorTypeId">مرتكب الانتهاك (اختياري)</label>
            <select
              id="perpetratorTypeId"
              formControlName="perpetratorTypeId"
              [disabled]="loadingPerpetratorTypes || perpetratorTypes.length === 0"
            >
              <option [ngValue]="null">غير محدد</option>
              <option *ngFor="let pt of perpetratorTypes" [value]="pt.id">{{ pt.name }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="violationDate">تاريخ الحادثة *</label>
            <div class="datetime-input-wrapper">
              <div class="datetime-input-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <input
                type="date"
                id="violationDate"
                formControlName="violationDate"
                [class.invalid]="isFieldInvalid(violationForm, 'violationDate')"
                [max]="maxDate"
                class="datetime-input"
                placeholder="اختر التاريخ"
              />
            </div>
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'violationDate')">
              تاريخ الحادثة مطلوب
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="address">العنوان *</label>
          <input
            type="text"
            id="address"
            formControlName="address"
            placeholder="أين وقعت هذه الحادثة؟"
            [class.invalid]="isFieldInvalid(violationForm, 'address')"
          />
          <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'address')">
            العنوان مطلوب
          </div>
        </div>

        <div class="form-group">
          <label for="description">الوصف *</label>
          <textarea
            id="description"
            formControlName="description"
            placeholder="قدم معلومات مفصلة عن الحادثة"
            [class.invalid]="isFieldInvalid(violationForm, 'description')"
            rows="5"
          ></textarea>
          <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'description')">
            الوصف مطلوب
          </div>
        </div>

        <div class="form-group">
          <label for="gender">الجنس (اختياري)</label>
          <select id="gender" formControlName="gender">
            <option [ngValue]="null">غير محدد</option>
            <option [ngValue]="GenderOption.Male">ذكر</option>
            <option [ngValue]="GenderOption.Female">أنثى</option>
          </select>
        </div>

        <div class="form-group">
          <label for="violationType">صفة المبلغ *</label>
          <select
            id="violationType"
            formControlName="violationType"
            [class.invalid]="isFieldInvalid(violationForm, 'violationType')"
          >
            <option [value]="PublicViolationType.Victim">صاحب البلاغ</option>
            <option [value]="PublicViolationType.Witness">شاهد</option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'violationType')">
            صفة المبلغ مطلوبة
          </div>
        </div>
      </div>

      <!-- Step 2: Contact Information -->
      <div *ngIf="currentStep === 2" class="form-step">
        <h2 class="step-title">معلومات الاتصال</h2>
        <p class="step-description">سيتم الحفاظ على سرية معلومات الاتصال الخاصة بك</p>
        
        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              formControlName="canContact"
            />
            <span>يمكن الاتصال بي</span>
          </label>
        </div>

        <div *ngIf="violationForm.get('canContact')?.value" class="contact-fields">
          <div class="form-group">
            <label for="email">البريد الإلكتروني</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              placeholder="example@email.com"
              [class.invalid]="isFieldInvalid(violationForm, 'email')"
            />
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'email')">
              بريد إلكتروني صحيح
            </div>
          </div>
          <div class="form-group">
            <label for="phoneNumber">رقم الهاتف</label>
            <input
              type="tel"
              id="phoneNumber"
              formControlName="phoneNumber"
              placeholder="05xxxxxxxx"
              [class.invalid]="isFieldInvalid(violationForm, 'phoneNumber')"
            />
          </div>
          <div class="error-message" *ngIf="isContactInfoRequiredError()">
            يرجى إدخال البريد الإلكتروني أو رقم الهاتف على الأقل
          </div>
          <div class="form-group">
            <label>الطريقة المفضلة للتواصل *</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" formControlName="preferredContactMethod" value="email" />
                <span>البريد الإلكتروني</span>
              </label>
              <label class="radio-label">
                <input type="radio" formControlName="preferredContactMethod" value="phone" />
                <span>الهاتف</span>
              </label>
            </div>
            <div class="error-message" *ngIf="isFieldInvalid(violationForm, 'preferredContactMethod')">
              يرجى اختيار الطريقة المفضلة للتواصل
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Attachments -->
      <div *ngIf="currentStep === 3" class="form-step">
        <h2 class="step-title">المرفقات</h2>
        <p class="step-description">يمكنك إرفاق صور أو فيديوهات متعلقة بالحادثة</p>
        
        <div class="form-group">
          <label for="attachments">رفع الملفات</label>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="attachments"
              multiple
              accept="image/*,video/*"
              (change)="onFileSelected($event)"
            />
            <label 
              for="attachments" 
              class="file-input-label"
              [class.has-files]="attachments.length > 0"
            >
              <svg class="file-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span class="file-input-text">
                {{ attachments.length > 0 ? 'تم اختيار ' + attachments.length + ' ملف' : 'انقر أو اسحب الملفات هنا' }}
              </span>
              <span class="file-input-hint">يمكن رفع صور أو فيديوهات (حد أقصى 100 ميجابايت لكل ملف)</span>
            </label>
          </div>
        </div>

        <div class="attachments-preview" *ngIf="attachmentPreviews.length > 0">
          <div *ngFor="let preview of attachmentPreviews; let i = index" class="attachment-item">
            <img *ngIf="preview.preview && preview.file.type.startsWith('image/')" [src]="preview.preview" alt="Preview" />
            <video *ngIf="preview.preview && preview.file.type.startsWith('video/')" [src]="preview.preview" controls class="attachment-video" (click)="$event.stopPropagation()"></video>
            <div *ngIf="!preview.preview" class="video-placeholder">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
            </div>
            <div class="attachment-info">
              <span>{{ preview.file.name }}</span>
              <span class="file-size">({{ (preview.file.size / 1024 / 1024).toFixed(2) }} MB)</span>
            </div>
            <button type="button" class="btn-remove" (click)="removeAttachment(i)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 4: Review & Submit -->
      <div *ngIf="currentStep === 4" class="form-step">
        <h2 class="step-title">المراجعة والإرسال</h2>
        <p class="step-description">يرجى مراجعة المعلومات قبل الإرسال</p>
        
        <div class="review-section">
          <div class="review-card">
            <h3 class="review-card-title">المعلومات الأساسية</h3>
            <div class="review-grid">
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  <strong>المدينة:</strong>
                </div>
                <div class="review-value">{{ getSelectedCityName() }}</div>
              </div>
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18M9 3v18"/>
                  </svg>
                  <strong>الفئة:</strong>
                </div>
                <div class="review-value">{{ getSelectedCategoryName() }}</div>
              </div>
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18M9 3v18M12 3v18"/>
                  </svg>
                  <strong>الفئة الفرعية:</strong>
                </div>
                <div class="review-value">{{ getSelectedSubCategoryName() }}</div>
              </div>
              <div class="review-item" *ngIf="violationForm.get('perpetratorTypeId')?.value">
                <div class="review-label">
                  <strong>مرتكب الانتهاك:</strong>
                </div>
                <div class="review-value">{{ getSelectedPerpetratorTypeName() }}</div>
              </div>
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  <strong>تاريخ الحادثة:</strong>
                </div>
                <div class="review-value">{{ getViolationDateValue() }}</div>
              </div>
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  <strong>العنوان:</strong>
                </div>
                <div class="review-value">{{ getAddressValue() }}</div>
              </div>
              <div class="review-item">
                <div class="review-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                  </svg>
                  <strong>صفة المبلغ:</strong>
                </div>
                <div class="review-value">{{ getViolationTypeLabel() }}</div>
              </div>
            </div>
          </div>

          <div class="review-card">
            <h3 class="review-card-title">تفاصيل الحادثة</h3>
            <div class="review-item review-item-full">
              <div class="review-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
                <strong>الوصف:</strong>
              </div>
              <div class="review-value review-description">{{ getDescriptionValue() }}</div>
            </div>
          </div>

          <div class="review-card" *ngIf="getCanContactValue()">
            <h3 class="review-card-title">معلومات الاتصال</h3>
            <div class="review-item" *ngIf="getEmailValue()">
              <div class="review-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                <strong>البريد الإلكتروني:</strong>
              </div>
              <div class="review-value">{{ getEmailValue() }}</div>
            </div>
            <div class="review-item" *ngIf="getPhoneValue()">
              <div class="review-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                <strong>رقم الهاتف:</strong>
              </div>
              <div class="review-value">{{ getPhoneValue() }}</div>
            </div>
            <div class="review-item" *ngIf="getPreferredContactLabel()">
              <div class="review-label">
                <strong>الطريقة المفضلة:</strong>
              </div>
              <div class="review-value">{{ getPreferredContactLabel() }}</div>
            </div>
          </div>

          <div class="review-card" *ngIf="attachments.length > 0">
            <h3 class="review-card-title">المرفقات</h3>
            <div class="review-attachments">
              <div class="review-attachment-count">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
                <span>عدد المرفقات: <strong>{{ attachments.length }}</strong></span>
              </div>
              <div class="review-attachment-preview">
                <div *ngFor="let preview of attachmentPreviews; let i = index" class="review-attachment-item">
                  <img *ngIf="preview.preview" [src]="preview.preview" alt="Preview" />
                  <div *ngIf="!preview.preview" class="review-video-placeholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="23 7 16 12 23 17 23 7"/>
                      <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                  </div>
                  <div class="review-attachment-name">{{ preview.file.name }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button
          type="button"
          class="btn-secondary"
          (click)="previousStep()"
          [disabled]="currentStep === 1"
        >
          السابق
        </button>
        <button
          *ngIf="currentStep < totalSteps"
          type="button"
          class="btn-primary"
          (click)="nextStep()"
        >
          التالي
        </button>
        <button
          *ngIf="currentStep === totalSteps"
          type="button"
          class="btn-primary"
          (click)="onSubmit()"
          [disabled]="submitting || violationForm.invalid"
        >
          {{ submitting ? 'جاري الإرسال...' : 'البلاغ' }}
        </button>
      </div>
    </div>
  </div>
</div>
