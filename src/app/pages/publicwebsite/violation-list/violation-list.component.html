<div class="violation-list">
  <div class="container">
    <div class="page-header">
      <h1>الحوادث المنشورة</h1>
      <p>عرض جميع الحوادث المبلغ عنها وحالتها الحالية</p>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filters-header" (click)="showFilters = !showFilters">
        <span>التصفية</span>
        <svg [class.rotated]="showFilters" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>
      <div class="filters-content" *ngIf="showFilters">
        <form [formGroup]="filterForm">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="cityId">المدينة:</label>
              <select id="cityId" formControlName="cityId" [disabled]="loadingCities">
                <option [ngValue]="null">جميع المدن</option>
                <option *ngFor="let city of cities" [ngValue]="city.id">{{ city.name }}</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="categoryId">الفئة:</label>
              <select id="categoryId" formControlName="categoryId">
                <option [ngValue]="null">جميع الفئات</option>
                <option *ngFor="let category of categories" [ngValue]="category.id">{{ category.name }}</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="dateFrom">من تاريخ:</label>
              <input type="date" id="dateFrom" formControlName="dateFrom">
            </div>

            <div class="filter-group">
              <label for="dateTo">إلى تاريخ:</label>
              <input type="date" id="dateTo" formControlName="dateTo">
            </div>
          </div>

          <div class="filters-actions">
            <button type="button" class="btn-secondary" (click)="resetFilters()">
              إعادة تعيين
            </button>
            <button type="button" class="btn-primary" (click)="applyFilters()">
              تطبيق التصفية
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="loading" *ngIf="loading">
      <p>جاري تحميل الحوادث...</p>
    </div>

    <div class="violations-container" *ngIf="!loading">
      <div class="alert alert-info" *ngIf="filteredViolations.length === 0">
        لم يتم العثور على حوادث تطابق معايير البحث.
      </div>

      <div class="incident-item" *ngFor="let violation of filteredViolations">
        <div class="incident-badge">{{ violation.categoryName || 'غير محدد' }}</div>
        <div class="incident-header-details">
          <span class="incident-id">حادثة #{{ violation.id }}</span>
          <span class="incident-date">{{ violation.violationDate | date:'medium' }}</span>
        </div>
        <h3 class="incident-title">{{ violation.subCategoryName || 'غير محدد' }}</h3>
        <p class="incident-desc">{{ violation.description }}</p>
        
        <div class="incident-details">
          <div class="detail-item" *ngIf="violation.cityName">
            <span class="detail-label">المدينة:</span>
            <span class="detail-value">{{ violation.cityName }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">الموقع:</span>
            <span class="detail-value">{{ getLocation(violation) }}</span>
          </div>
        </div>
        
        <div class="incident-meta">
          <span class="meta-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            {{ getLocation(violation) }}
          </span>
          <span class="meta-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            {{ violation.creationDate | date:'medium' }}
          </span>
        </div>
        
        <!-- Attachments Section -->
        <div class="incident-attachments" *ngIf="violation.attachments && violation.attachments.length > 0">
          <div class="attachments-label">المرفقات:</div>
          <div class="attachments-grid">
            <div class="attachment-item" *ngFor="let attachment of violation.attachments">
              <img 
                *ngIf="isImage(attachment.fileType)" 
                [src]="getAttachmentUrl(attachment.filePath)" 
                [alt]="attachment.fileName"
                (click)="openAttachment(attachment)"
                class="attachment-image"
              />
              <div 
                *ngIf="!isImage(attachment.fileType)" 
                class="attachment-file"
                (click)="openAttachment(attachment)"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <span>{{ attachment.fileName }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-summary" *ngIf="!loading">
      <div class="stat-item">
        <span class="stat-label">الاجمالي:</span>
        <span class="stat-value">{{ totalPublishedCount }}</span>
      </div>
    
      <div class="stat-item" *ngFor="let category of categories">
        <span class="stat-label">{{ category.name }}:</span>
        <span class="stat-value">{{ getCountByCategory(category.id) }}</span>
      </div>
    </div>
  </div>
</div>
