<div class="unified-table-wrapper">
  <!-- Search and Filters -->
  <div class="table-controls" *ngIf="showSearch || hasFilterableColumns()">
    <div class="search-box" *ngIf="showSearch">
      <input
        type="text"
        [value]="searchTerm"
        (input)="onSearch($any($event.target).value)"
        placeholder="بحث..."
        class="search-input"
      />
      <lucide-icon [img]="Search" [size]="20" class="search-icon"></lucide-icon>
    </div>

    <div class="column-filters" *ngIf="hasFilterableColumns()">
      <div class="filter-item" *ngFor="let col of columns">
        <input
          *ngIf="col.filterable"
          type="text"
          [value]="columnFilters[col.key] || ''"
          (input)="onFilterChange(col.key, $any($event.target).value)"
          [placeholder]="'تصفية ' + col.label"
          class="filter-input"
        />
      </div>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="table-container desktop-table">
    <table class="unified-table">
      <thead>
        <tr>
          <th
            *ngFor="let col of columns"
            [style.width]="col.width"
            [class.sortable]="col.sortable"
            [class.sorted]="sortColumn === col.key"
            [class.sort-asc]="sortColumn === col.key && sortDirection === 'asc'"
            [class.sort-desc]="sortColumn === col.key && sortDirection === 'desc'"
            (click)="col.sortable && onSort(col)"
          >
            <div class="th-content">
              <span>{{ col.label }}</span>
              <lucide-icon
                *ngIf="col.sortable && getSortIcon(col)"
                class="sort-icon"
                [img]="getSortIcon(col)"
                [size]="16"
              ></lucide-icon>
              <span *ngIf="col.sortable && !getSortIcon(col)" class="sort-placeholder"></span>
            </div>
          </th>
          <th *ngIf="actions.length > 0" class="actions-header">
            <div class="th-content">
              <span>الإجراءات</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="loading">
          <td [attr.colspan]="columns.length + (actions.length > 0 ? 1 : 0)" class="loading-cell">
            <div class="loading-spinner">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span>جاري التحميل...</span>
          </td>
        </tr>
        <tr *ngIf="!loading && paginatedData.length === 0">
          <td [attr.colspan]="columns.length + (actions.length > 0 ? 1 : 0)" class="empty-cell">
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <p>{{ emptyMessage }}</p>
            </div>
          </td>
        </tr>
        <tr
          *ngFor="let row of paginatedData"
          class="table-row"
          (click)="onRowClick(row)"
        >
          <td *ngFor="let col of columns" [class]="'cell-' + (col.type || 'text')" [class.has-code-chip]="col.key === 'name'" [class.has-group-chip]="col.key === 'type'">
            <span *ngIf="col.type === 'badge'" class="badge" [ngClass]="'badge-' + getCellValue(row, col.key)">
              {{ getCellDisplay(row, col) }}
            </span>
            <span *ngIf="col.type === 'date'">{{ getCellValue(row, col.key) | date:'short' }}</span>
            <span *ngIf="col.type === 'chip'" class="chip">{{ getCellDisplay(row, col) }}</span>
            <div *ngIf="col.type === 'icon' && getCellValue(row, col.key)" class="icon-cell">
              <lucide-icon 
                *ngIf="col.iconRenderer"
                [img]="col.iconRenderer(getCellValue(row, col.key), row)" 
                [size]="20"
                [title]="col.label"
              ></lucide-icon>
            </div>
            <button 
              *ngIf="col.type === 'toggle' && col.toggleAction" 
              type="button"
              class="toggle-btn"
              [class.active]="getCellValue(row, col.key)"
              [class.toggling]="col.isToggling && col.isToggling(row)"
              [disabled]="col.isToggling && col.isToggling(row)"
              (click)="col.toggleAction(row, $event)"
              [title]="getCellValue(row, col.key) ? 'إلغاء التفعيل' : 'تفعيل'"
            >
              <lucide-icon 
                [img]="getCellValue(row, col.key) ? Power : PowerOff" 
                [size]="18"
              ></lucide-icon>
            </button>
            <span 
              *ngIf="col.type === 'toggle' && !col.toggleAction"
              class="toggle-readonly"
              [class.active]="getCellValue(row, col.key)"
            >
              <lucide-icon 
                [img]="getCellValue(row, col.key) ? Power : PowerOff" 
                [size]="18"
              ></lucide-icon>
              <span>{{ getCellValue(row, col.key) ? 'نشط' : 'غير نشط' }}</span>
            </span>
            <span *ngIf="col.type !== 'badge' && col.type !== 'date' && col.type !== 'chip' && col.type !== 'toggle' && col.type !== 'icon'" [class.code-chip]="col.key === 'name'" [class.group-chip]="col.key === 'type'">
              {{ getCellDisplay(row, col) }}
            </span>
          </td>
          <td *ngIf="actions.length > 0" class="actions-cell" (click)="$event.stopPropagation()">
            <div class="action-buttons">
              <ng-container *ngFor="let action of actions">
                <button
                  *ngIf="!action.condition || action.condition(row)"
                  type="button"
                  class="action-btn"
                  [ngClass]="[action.class, 'btn-' + (action.variant || 'default')]"
                  (click)="onActionClick(action, row, $event)"
                  [title]="action.label"
                >
                  <lucide-icon [img]="getDefaultIcon(action)" [size]="18"></lucide-icon>
                  <span *ngIf="action.showLabel !== false">{{ action.label }}</span>
                </button>
              </ng-container>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile Cards -->
  <div class="mobile-cards">
    <div *ngIf="loading" class="card-loading">
      <div class="loading-spinner">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <span>جاري التحميل...</span>
    </div>
    
    <div *ngIf="!loading && paginatedData.length === 0" class="card-empty">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <p>{{ emptyMessage }}</p>
      </div>
    </div>
    
    <div
      *ngFor="let row of paginatedData"
      class="mobile-card"
      (click)="onRowClick(row)"
    >
      <div class="card-content">
        <div *ngFor="let col of columns" class="card-field">
          <div class="card-label">{{ col.label }}</div>
          <div class="card-value" [class]="'value-' + (col.type || 'text')">
            <span *ngIf="col.type === 'badge'" class="badge" [ngClass]="'badge-' + getCellValue(row, col.key)">
              {{ getCellDisplay(row, col) }}
            </span>
            <span *ngIf="col.type === 'date'">{{ getCellValue(row, col.key) | date:'short' }}</span>
            <span *ngIf="col.type !== 'badge' && col.type !== 'date'">{{ getCellDisplay(row, col) }}</span>
          </div>
        </div>
      </div>
      <div class="card-actions" *ngIf="actions.length > 0" (click)="$event.stopPropagation()">
        <button
          *ngFor="let action of actions"
          type="button"
          class="card-action-btn"
          [ngClass]="action.class"
          (click)="onActionClick(action, row, $event)"
        >
          {{ action.label }}
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="table-pagination" *ngIf="showPagination && totalPages > 1">
    <div class="pagination-info">
      <span>عرض {{ getStartIndex() }} - {{ getEndIndex() }} من {{ getTotalCount() }}</span>
    </div>
    <div class="pagination-controls">
      <button
        type="button"
        class="page-btn"
        [disabled]="currentPage === 1"
        (click)="goToPage(currentPage - 1)"
      >
        <lucide-icon [img]="ChevronRight" [size]="18"></lucide-icon>
        السابق
      </button>
      <div class="page-numbers">
        <button
          *ngFor="let page of getPageNumbers()"
          type="button"
          class="page-number"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
      </div>
      <button
        type="button"
        class="page-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(currentPage + 1)"
      >
        التالي
        <lucide-icon [img]="ChevronLeft" [size]="18"></lucide-icon>
      </button>
    </div>
  </div>
</div>
